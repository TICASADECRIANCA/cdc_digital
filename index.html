<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#004aad">
    
    <title>CASA+ Gest√£o</title>
    <style>
        /* --- CSS BASE --- */
        :root { --primary: #004aad; --sec: #0097b2; --bg: #f4f6f8; --text: #333; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; --gray: #7f8c8d; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        
        /* GERAL */
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }
        button:active { transform: scale(0.98); }
        input, select, textarea { font-family: inherit; font-size: 16px; }

        /* AUTH COM FUNDO */
        .auth-container { 
            position: absolute; top:0; left:0; width:100%; height:100%; z-index:99; 
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fundo_escola.jpg');
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center; padding: 20px; 
        }
        .card-auth { background: rgba(255, 255, 255, 0.95); padding: 2rem; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 100%; max-width: 380px; text-align: center; backdrop-filter: blur(5px); }
        .card-auth img { width: 120px; margin-bottom: 20px; }
        .card-auth input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
        .card-auth button { width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; font-size: 1rem; }
        .link-text { color: var(--primary); margin-top: 15px; display: block; font-size: 0.9rem; text-decoration: underline; cursor: pointer; }

        /* APP LAYOUT */
        #app-painel { display: flex; flex-direction: column; height: 100%; }
        .app-header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; height: 60px; }
        .header-title { font-weight: bold; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .turma-badge { background: var(--sec); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; }
        .btn-logout { background: none; border: none; color: var(--danger); font-size: 0.9rem; font-weight: bold; }
        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }

        /* TABS */
        .nav-tabs { display: flex; justify-content: center; background: white; border-bottom: 1px solid #eee; }
        .nav-item { padding: 15px 30px; cursor: pointer; color: var(--gray); border-bottom: 3px solid transparent; font-weight: 500; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* CONTROLS */
        .action-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .date-control { display: flex; align-items: center; gap: 10px; font-weight: bold; color: #555; }
        .date-control input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-group { display: flex; gap: 8px; }
        .btn-action { padding: 8px 16px; border-radius: 6px; border: none; color: white; font-weight: bold; font-size: 0.9rem; }
        .btn-save { background: var(--success); }
        .btn-hist { background: var(--gray); }
        .btn-print { background: #2c3e50; }
        .btn-del { background: var(--danger); }
        .btn-report { background: #8e44ad; }
        .btn-fix { background: var(--warning); color: #fff; }

        /* TABLES & CARDS */
        .desktop-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .desktop-table th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        .desktop-table td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .mobile-card-list { display: none; }
        .student-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; }
        .student-card.status-presente { border-left-color: var(--success); }
        .student-card.status-ausente { border-left-color: var(--danger); opacity: 0.9; }
        .student-card.status-exaluno { border-left-color: #7f8c8d; background: #fdfdfd; }
        .student-info strong { display: block; font-size: 1rem; color: #333; }
        .student-info span { font-size: 0.8rem; color: #888; }
        .texto-removido { color: #c0392b; font-size: 0.85em; font-style: italic; }
        
        .toggle-btn { padding: 8px 20px; border-radius: 20px; border: none; font-weight: bold; color: white; width: 110px; }
        .toggle-btn.presente { background: var(--success); }
        .toggle-btn.ausente { background: var(--danger); }
        .toggle-btn.ex-btn { opacity: 0.7; cursor: default; }

        .plan-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .plan-box textarea { width: 100%; border: 1px solid #ddd; background: #fafafa; border-radius: 8px; padding: 10px; resize: vertical; min-height: 100px; }

        /* MODAIS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .grid-coord { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card-turma { background: white; border: 2px solid var(--primary); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; }
        .card-turma:hover { background: var(--primary); color: white; }

        /* MOBILE QUERY */
        @media (max-width: 768px) {
            .nav-tabs { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; z-index: 100; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); }
            .nav-item { border: none; padding: 10px; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
            .nav-item span { font-size: 1.2rem; margin-bottom: 2px; }
            .nav-item.active { color: var(--primary); background: transparent; border: none; }
            .desktop-table { display: none; }
            .mobile-card-list { display: block; }
            .action-bar { flex-direction: column; align-items: stretch; }
            .date-control { justify-content: space-between; margin-bottom: 10px; }
            .date-control input { width: 60%; }
            .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .btn-group button { width: 100%; }
            .modal-overlay { align-items: flex-end; }
            .modal-content { border-radius: 15px 15px 0 0; margin: 0; width: 100%; }
        }
        @media print {
            .app-header, .nav-tabs, .action-bar, .no-print, #view-login, #view-cadastro, #view-coord, .btn-group { display: none !important; }
            .modal-overlay { position: static; background: white; height: auto; display: block !important; }
            .modal-content { box-shadow: none; border: none; max-width: 100%; width: 100%; }
            body > * { display: none !important; }
            body > #print-area { display: block !important; }
            
            body.printing-report #modal-relatorio { display: block !important; }
            body.printing-report #modal-relatorio .modal-content { width: 100%; padding:0; }
            body.printing-report #resultado-relatorio { max-height: none !important; overflow: visible !important; }
        }
    </style>
</head>
<body>

    <div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; justify-content:center; align-items:center; color:var(--primary); font-weight:bold; font-size:1.2rem;">Carregando...</div>

    <div id="print-header" class="hidden">
        <h2 style="text-align:center;">Relat√≥rio Escolar</h2>
        <p><strong>Turma:</strong> <span id="p-turma"></span> | <strong>Data:</strong> <span id="p-data"></span></p>
        <hr>
    </div>

    <div id="view-login" class="auth-container">
        <div class="card-auth">
            <img src="logo.png" alt="Logo">
            <h3 style="color:var(--primary); margin:0 0 20px 0;">Acesso Professor</h3>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-senha" placeholder="Senha">
            <button onclick="window.fazerLogin()">ENTRAR</button>
            <span class="link-text" onclick="window.validarAcessoCadastro()">Criar nova conta</span>
            <span class="link-text" style="color:#999; font-size:0.8rem; margin-top:30px;" onclick="window.abrirAreaAdmin()">Admin/Secretaria</span>
        </div>
    </div>

    <div id="view-cadastro" class="auth-container hidden">
        <div class="card-auth">
            <h3 style="color:var(--primary);">Novo Usu√°rio</h3>
            <input type="text" id="cad-nome" placeholder="Nome Completo">
            <input type="email" id="cad-email" placeholder="E-mail">
            <input type="password" id="cad-senha" placeholder="Senha">
            <div style="text-align:left; margin:10px 0;">
                <label style="font-size:0.85rem; font-weight:bold;">Tipo de Conta:</label>
                <select id="cad-tipo" onchange="window.alternarTipoCadastro()" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ddd;">
                    <option value="professor">Professor (1 Turma)</option>
                    <option value="coordenador">Coordena√ß√£o</option>
                </select>
            </div>
            <div id="area-select-unica">
                <select id="cad-turma-unica" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"><option value="" disabled selected>Selecione a Turma</option></select>
            </div>
            <div id="area-select-coord" class="hidden" style="text-align:left;">
                <select id="cad-perfil-coord" onchange="window.verificarPerfilCustomizado()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;">
                    <option value="" disabled selected>Selecione o Perfil...</option>
                    <option value="GERAL">Dire√ß√£o Geral</option>
                    <option value="CRISTIANE">Coord. Cristiane</option>
                    <option value="ADNA">Coord. Adna</option>
                    <option value="NAYARA">Coord. Nayara</option>
                    <option value="LUDMILLA">Coord. Ludmilla</option>
                    <option value="ELIONEIDE">Coord. Elioneide</option>
                    <option value="SAVIA">Coord. Savia</option>
                    <option value="COORD_ESPORTES">Coord. de Esportes/Extras</option>
                    <option value="CUSTOM">Outro</option>
                </select>
                <div id="container-checkboxes" class="hidden" style="max-height:100px; overflow-y:auto; border:1px solid #ccc; padding:5px; font-size:0.85rem;"></div>
            </div>
            <button onclick="window.fazerCadastro()" class="btn-save">Cadastrar</button>
            <button onclick="window.showView('login')" style="background:transparent; color:#666; margin-top:0;">Cancelar</button>
        </div>
    </div>

    <div id="view-coord" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <div class="app-header">
            <div class="header-title">üëë Painel Gest√£o</div>
            <button onclick="window.fazerLogout()" class="btn-logout">Sair</button>
        </div>
        <div class="main-content">
            <h4 style="color:#666; margin-bottom:15px;">Selecione uma turma para acessar:</h4>
            <div id="container-turmas" class="grid-coord"></div>
        </div>
    </div>

    <div id="app-painel" class="hidden">
        <div class="app-header">
            <div class="header-title">
                <span id="btn-voltar-coord" class="hidden" onclick="window.voltarParaCoord()" style="font-size:1.2rem; margin-right:5px;">‚¨Ö</span>
                <span id="display-turma-nome">Turma</span>
                <span id="display-turma-badge" class="turma-badge">...</span>
            </div>
            <button onclick="window.fazerLogout()" class="btn-logout">Sair</button>
        </div>
        
        <div class="main-content">
            
            <div id="tab-freq" class="view-section">
                <div class="action-bar">
                    <div class="date-control">
                        <span>Data:</span>
                        <input type="date" id="data-freq" onchange="window.carregarFrequencia()">
                    </div>
                    <div class="btn-group">
                        <button onclick="window.salvarChamada()" class="btn-action btn-save">Salvar</button>
                        <button onclick="window.abrirRelatorioMensal()" class="btn-action btn-report">üìä Relat√≥rio</button>
                        <button onclick="window.abrirHistorico('freq')" class="btn-action btn-hist">Hist√≥rico</button>
                        <button onclick="window.imprimirTela('freq')" class="btn-action btn-print">Imprimir</button>
                    </div>
                </div>

                <table class="desktop-table">
                    <thead><tr><th>N¬∫</th><th>Aluno</th><th style="text-align:center">Status</th><th class="no-print">Apagar</th></tr></thead>
                    <tbody id="tbody-alunos"></tbody>
                </table>
                <div id="mobile-lista" class="mobile-card-list"></div>
                <div id="empty-msg" style="text-align:center; padding:20px; color:#999; display:none;">Nenhum aluno cadastrado.</div>
            </div>

            <div id="tab-plan" class="view-section hidden">
                <div class="action-bar">
                    <div class="date-control">
                        <span>Data:</span>
                        <input type="date" id="data-plan" onchange="window.carregarPlanejamento()">
                    </div>
                    <div class="btn-group">
                        <button onclick="window.salvarPlanejamento()" class="btn-action btn-save">Salvar</button>
                        <button onclick="window.excluirPlanejamento()" class="btn-action btn-del">Excluir</button>
                        <button onclick="window.abrirHistorico('plan')" class="btn-action btn-hist">Ver Salvos</button>
                        <button onclick="window.imprimirTela('plan')" class="btn-action btn-print">Imprimir</button>
                    </div>
                </div>
                <div class="plan-box">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="color:var(--primary); margin:0;">Registro Di√°rio</h3>
                        <button id="btn-unlock" onclick="window.desbloquearEdicao()" style="background:var(--warning); color:white; border:none; padding:5px 10px; border-radius:5px; font-size:0.8rem; display:none;">üîì Editar</button>
                    </div>
                    <label>Titulo:</label>
                    <input type="text" id="plan-disciplina" class="input-plan" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:8px;">
                    <label>Conte√∫do / Resultados esperados:</label>
                    <textarea id="plan-metodologia" class="input-plan"></textarea>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" id="nav-freq" onclick="window.mudarAba('freq')"><span>üìÖ</span> Chamada</div>
            <div class="nav-item" id="nav-plan" onclick="window.mudarAba('plan')"><span>üìñ</span> Di√°rio</div>
            <div class="nav-item" onclick="window.open('reunioes.html', '_blank')"><span>üìù</span> Reuni√µes</div>
        </div>
    </div>

    <div id="modal-relatorio" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-top:0;">üìä Relat√≥rio Mensal</h3>
            <div class="no-print" style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #eee;">
                <label>Selecione o M√™s:</label>
                <input type="month" id="mes-relatorio" style="width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ccc;">
                <button onclick="window.gerarRelatorioFaltas()" class="btn-action btn-save" style="width:100%; margin-top:10px;">Gerar Relat√≥rio</button>
            </div>
            <div id="resultado-relatorio" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
            
            <button onclick="window.imprimirRelatorio()" class="btn-action btn-print no-print" style="width:100%; margin-bottom:10px;">üñ®Ô∏è Imprimir este Relat√≥rio</button>
            <button onclick="document.getElementById('modal-relatorio').style.display='none'" class="btn-action btn-hist no-print" style="width:100%;">Fechar</button>
        </div>
    </div>

    <div id="modal-historico" class="modal-overlay" onclick="if(event.target === this) window.fecharHistorico()">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Hist√≥rico</h3>
                <button onclick="window.fecharHistorico()" style="background:#eee; border:none; width:30px; height:30px; border-radius:50%; font-weight:bold;">‚úï</button>
            </div>
            <div id="modal-lista-conteudo"></div>
        </div>
    </div>

    <div id="modal-admin" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color:var(--primary); margin-top:0;">Secretaria (Gest√£o)</h2>
            
            <div style="border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:20px; background:#f9f9f9;">
                <h4 style="margin:0 0 10px 0;">Importar Alunos (Massa)</h4>
                <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">Formato: <strong>Nome, Turma</strong></p>
                <textarea id="lista-alunos-massa" style="width:100%; height:100px; margin-bottom:10px;"></textarea>
                <button onclick="window.importarAlunosMassa()" class="btn-action btn-save" style="width:100%;">Importar Alunos</button>
            </div>
            
            <div style="border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:20px; background:#f9f9f9;">
                <h4 style="margin:0 0 10px 0;">Criar Contas (Professores)</h4>
                <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">Formato: <strong>Nome, Turma, Email, Senha</strong></p>
                <textarea id="lista-profs-import" style="width:100%; height:80px; margin-bottom:10px;"></textarea>
                <button onclick="window.processarImportacaoProfs()" class="btn-action btn-save" style="width:100%;">Criar Professores</button>
            </div>
            
            <div style="border:1px solid #e67e22; padding:15px; border-radius:8px; background:#fffaf0; margin-bottom:20px;">
                <h4 style="color:#e67e22; margin:0 0 10px 0;">üõ†Ô∏è Manuten√ß√£o</h4>
                <button onclick="window.removerDuplicados()" class="btn-action btn-fix" style="width:100%; margin-bottom:10px;">Remover Alunos Duplicados</button>
                <button onclick="window.limparBancoAlunos()" class="btn-action btn-del" style="width:100%;">Excluir TODOS os Alunos</button>
            </div>

            <button onclick="document.getElementById('modal-admin').style.display='none'" class="btn-action btn-hist" style="width:100%;">Fechar Painel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjtXXfchJQO4vxeI_Vqw1QhV_1CLwB6jc", authDomain: "escoladigital-79997.firebaseapp.com", projectId: "escoladigital-79997", storageBucket: "escoladigital-79997.appspot.com", messagingSenderId: "system", appId: "system" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ESTRUTURA_TURMAS = { 
            "Ber√ß√°rio": [ { nome: "Ber√ß√°rio", letras: ["A"] } ],
            "Infantil 1": [ { nome: "Infantil 1", letras: ["A", "B", "C", "D", "E", "F", "G"] } ],
            "Infantil 2": [ { nome: "Infantil 2", letras: ["A", "B", "C", "D", "E", "F", "G", "I", "J"] } ], 
            "Infantil 3": [ { nome: "Infantil 3", letras: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"] } ], 
            "Infantil 4": [ { nome: "Infantil 4", letras: ["A", "B", "C", "D", "E", "F", "I", "J"] } ], 
            "Infantil 5": [ { nome: "Infantil 5", letras: ["A", "B", "C", "D", "E", "F", "G", "I"] } ],
            "Ensino Fundamental": [ { nome: "1¬∫ Ano", letras: ["A", "B", "C", "D", "I"] } ],
            "Esportes e Extras": [
                { nome: "Futsal", letras: ["A"] },
                { nome: "Dan√ßa", letras: ["A"] },
                { nome: "Gin√°stica R√≠tmica", letras: ["A"] },
                { nome: "Jud√¥", letras: ["A"] }
            ]
        };

        const REGRAS_COORDENACAO = {
            "CRISTIANE": ["Ber√ß√°rio A", "Infantil 1 A", "Infantil 1 B", "Infantil 1 C", "Infantil 1 D", "Infantil 1 E", "Infantil 1 F", "Infantil 1 G"],
            "ADNA": ["Infantil 2 A", "Infantil 2 B", "Infantil 2 C", "Infantil 2 D", "Infantil 2 E", "Infantil 2 F", "Infantil 2 G", "Infantil 2 I", "Infantil 2 J"],
            "NAYARA": ["Infantil 3 A", "Infantil 3 B", "Infantil 3 C", "Infantil 3 D", "Infantil 3 E", "Infantil 3 F", "Infantil 3 G", "Infantil 3 H"],
            "LUDMILLA": ["Infantil 3 I", "Infantil 3 J", "Infantil 4 I", "Infantil 4 J", "Infantil 5 A", "Infantil 5 B", "Infantil 5 C", "Infantil 5 D", "Infantil 5 E", "Infantil 5 F", "Infantil 5 G", "Infantil 5 I", "1¬∫ Ano I"],
            "ELIONEIDE": ["Infantil 4 A", "Infantil 4 B", "Infantil 4 C", "Infantil 4 D", "Infantil 4 E", "Infantil 4 F"],
            "SAVIA": ["1¬∫ Ano A", "1¬∫ Ano B", "1¬∫ Ano C", "1¬∫ Ano D"],
            "COORD_ESPORTES": ["Futsal A", "Dan√ßa A", "Gin√°stica R√≠tmica A", "Jud√¥ A"]
        };

        const SENHAS = { CADASTRO: "1992", SECRETARIA: "1992", EDICAO: "1992" };

        let usuarioAtual = null; 
        let perfilCoord = null;
        let listaAlunosCache = [];

        const loading = (s) => document.getElementById('loader').style.display = s ? 'flex' : 'none';
        const formatData = (d) => d.split('-').reverse().join('/');
        const getHoje = () => new Date().toISOString().split('T')[0];

        window.onload = () => {
            carregarOpcoesTurma();
            document.getElementById('data-freq').value = getHoje();
            document.getElementById('data-plan').value = getHoje();
            ['login-email', 'login-senha'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', (e) => { if(e.key === 'Enter') window.fazerLogin(); });
            });
        };

        window.showView = (viewName) => {
            ['view-login', 'view-cadastro', 'view-coord', 'app-painel'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const el = document.getElementById(viewName === 'login' ? 'view-login' : viewName === 'cadastro' ? 'view-cadastro' : viewName === 'coord' ? 'view-coord' : 'app-painel');
            el.classList.remove('hidden');
            if(viewName === 'app') el.style.display = 'flex'; 
        };

        window.mudarAba = (aba) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + aba).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + aba).classList.add('active');
        };

        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value.trim();
            if(!email || !senha) return alert("Preencha tudo.");
            loading(true);
            try {
                const q = query(collection(db, "professores"), where("email", "==", email), where("senha", "==", senha));
                const snap = await getDocs(q);
                if(snap.empty) alert("Dados incorretos.");
                else {
                    const user = snap.docs[0].data();
                    if(user.turma === "COORD" || user.acessos?.length) {
                        usuarioAtual = user; perfilCoord = user;
                        window.showView('coord');
                        renderCoordPainel(user.acessos || []);
                    } else {
                        usuarioAtual = user; perfilCoord = null;
                        document.getElementById('btn-voltar-coord').classList.add('hidden');
                        entrarTurma(user.turma, user.nome);
                    }
                }
            } catch(e) { console.error(e); alert("Erro de conex√£o."); } finally { loading(false); }
        };

        window.fazerLogout = () => { usuarioAtual = null; window.showView('login'); };

        function renderCoordPainel(acessos) {
            const container = document.getElementById('container-turmas'); container.innerHTML = "";
            const isGeral = acessos.includes("TODAS");
            for (const [g, ls] of Object.entries(ESTRUTURA_TURMAS)) {
                ls.forEach(se => se.letras.forEach(l => {
                    const nomeTurma = `${se.nome} ${l}`;
                    if(isGeral || acessos.includes(nomeTurma)) {
                        const div = document.createElement('div');
                        div.className = 'card-turma';
                        div.innerHTML = `<strong>${se.nome}</strong><br><small>Turma ${l}</small>`;
                        div.onclick = () => {
                            usuarioAtual = { nome: perfilCoord.nome + " (Coord)", turma: nomeTurma };
                            document.getElementById('btn-voltar-coord').classList.remove('hidden');
                            entrarTurma(nomeTurma, usuarioAtual.nome);
                        };
                        container.appendChild(div);
                    }
                }));
            }
        }
        window.voltarParaCoord = () => { usuarioAtual = perfilCoord; window.showView('coord'); };

        async function entrarTurma(turma, nomeProf) {
            document.getElementById('display-turma-nome').innerText = nomeProf.split(' ')[0];
            document.getElementById('display-turma-badge').innerText = turma;
            window.showView('app');
            window.mudarAba('freq');
            await carregarAlunosBase();
            await carregarFrequencia();
            await carregarPlanejamento();
        }

        async function carregarAlunosBase() {
            loading(true);
            try {
                const q = query(collection(db, "alunos"), where("turma", "==", usuarioAtual.turma));
                const snap = await getDocs(q);
                listaAlunosCache = [];
                snap.forEach(d => listaAlunosCache.push({id: d.id, ...d.data()}));
                listaAlunosCache.sort((a,b) => a.nome.localeCompare(b.nome));
            } catch(e) { console.log(e); } finally { loading(false); }
        }

        // --- RENDERIZADOR ---
        function renderizarTabelaAlunos(listaExibicao, faltosos = []) {
            const tbody = document.getElementById('tbody-alunos');
            const listaMob = document.getElementById('mobile-lista');
            tbody.innerHTML = ""; listaMob.innerHTML = "";

            if(listaExibicao.length === 0) document.getElementById('empty-msg').style.display = 'block';
            else document.getElementById('empty-msg').style.display = 'none';

            listaExibicao.forEach((aluno, idx) => {
                const isExAluno = aluno.exAluno;
                
                // Determina status
                let foiFalta = false;
                if(isExAluno) {
                    // Para ex-aluno, usamos o status guardado no hist√≥rico
                    foiFalta = !aluno.statusHistorico; 
                } else {
                    foiFalta = faltosos.includes(aluno.nome);
                }
                
                let statusClass = foiFalta ? "ausente" : "presente";
                let statusText = foiFalta ? "Ausente" : "Presente";

                const tr = document.createElement('tr');
                const btnDel = (perfilCoord && !isExAluno) ? `<button onclick="window.removerAluno('${aluno.id}')" style="background:none; border:none; color:red;">üóëÔ∏è</button>` : '';
                
                // Se for ex-aluno, bot√£o visual, sen√£o bot√£o funcional
                let btnHtml;
                if(isExAluno) {
                    btnHtml = `<button class="toggle-btn ${statusClass} ex-btn">${statusText}</button>`;
                } else {
                    btnHtml = `<button class="toggle-btn ${statusClass}" onclick="window.togglePresenca(this, '${aluno.id}')">${statusText}</button>`;
                }

                tr.innerHTML = `<td>${idx+1}</td>
                                <td>${aluno.nome} ${isExAluno ? '<span class="texto-removido">(Ex-Aluno)</span>':''}</td>
                                <td style="text-align:center">${btnHtml}</td>
                                <td class="no-print" style="text-align:center">${btnDel}</td>`;
                tbody.appendChild(tr);

                const card = document.createElement('div');
                card.className = `student-card status-${statusClass} ${isExAluno ? 'status-exaluno' : ''}`;
                card.innerHTML = `
                    <div class="student-info"><strong>${idx+1}. ${aluno.nome} ${isExAluno ? '<span class="texto-removido">(Ex-Aluno)</span>':''}</strong><span>${isExAluno ? 'Removido' : usuarioAtual.turma}</span></div>
                    ${isExAluno ? `<button class="toggle-btn ${statusClass} ex-btn">${statusText}</button>` : `<button class="toggle-btn ${statusClass}" onclick="window.togglePresenca(this, '${aluno.id}', true)">${statusText}</button>`}
                `;
                listaMob.appendChild(card);
            });
        }

        window.togglePresenca = (btn, id, isMobile) => {
            const isPres = btn.innerText === "Presente";
            const novoStatus = isPres ? "Ausente" : "Presente";
            const novaClasse = isPres ? "ausente" : "presente";
            btn.className = `toggle-btn ${novaClasse}`;
            btn.innerText = novoStatus;
            if(isMobile) {
                const card = document.getElementById(`card-${id}`);
                if(card) card.className = `student-card status-${novaClasse}`;
            }
        };

        // --- CARREGAR FREQUENCIA COM HISTORICO DE REMOVIDOS ---
        window.carregarFrequencia = async () => {
            const dt = document.getElementById('data-freq').value;
            if(dt > getHoje()) { alert("Data futura n√£o permitida."); document.getElementById('data-freq').value = getHoje(); return; }
            loading(true);

            try {
                const q = query(collection(db, "frequencia"), where("turma", "==", usuarioAtual.turma), where("data", "==", dt));
                const snap = await getDocs(q);
                
                let listaFinal = [...listaAlunosCache]; 
                let faltosos = [];

                if(!snap.empty) {
                    const dados = snap.docs[0].data();
                    if(dados.detalhes) {
                        faltosos = dados.detalhes.filter(d => !d.presente).map(d => d.nome);
                        
                        // Verifica alunos do hist√≥rico que sumiram da lista
                        dados.detalhes.forEach(hist => {
                            const existe = listaFinal.find(a => a.nome === hist.nome);
                            if(!existe) {
                                listaFinal.push({
                                    nome: hist.nome,
                                    id: null,
                                    exAluno: true,
                                    statusHistorico: hist.presente 
                                });
                            }
                        });
                    }
                }
                
                listaFinal.sort((a,b) => a.nome.localeCompare(b.nome));
                renderizarTabelaAlunos(listaFinal, faltosos);

            } catch(e){ console.error(e); } finally { loading(false); }
        };

        window.salvarChamada = async () => {
            loading(true);
            const dt = document.getElementById('data-freq').value;
            const detalhes = []; let presentes = 0;
            const rows = document.querySelectorAll('#tbody-alunos tr');
            if(!rows.length) { loading(false); return alert("Sem alunos."); }

            let totalValidos = 0;
            rows.forEach(tr => {
                // Pega o nome limpando o sufixo (Ex-Aluno) se houver
                const nomeRaw = tr.cells[1].innerText;
                const nomeLimpo = nomeRaw.replace('(Ex-Aluno)', '').trim();
                
                const btn = tr.querySelector('.toggle-btn');
                if(btn) { 
                    const isP = btn.innerText === "Presente"; // Verifica texto, pois classe pode variar
                    if(isP) presentes++;
                    detalhes.push({ nome: nomeLimpo, presente: isP });
                    totalValidos++;
                }
            });

            try {
                const idDoc = usuarioAtual.turma.replace(/\s/g,'') + "_" + dt;
                await setDoc(doc(db, "frequencia", idDoc), {
                    data: dt, turma: usuarioAtual.turma, detalhes, resumo: `${presentes} Presentes / ${totalValidos - presentes} Faltas`
                });
                alert("Salvo com sucesso!");
                window.carregarFrequencia();
            } catch(e) { alert("Erro ao salvar."); } finally { loading(false); }
        };

        window.abrirRelatorioMensal = () => {
            const hoje = new Date();
            const mesStr = hoje.toISOString().slice(0, 7); 
            document.getElementById('mes-relatorio').value = mesStr;
            document.getElementById('resultado-relatorio').innerHTML = "";
            document.getElementById('modal-relatorio').style.display = 'flex';
        };

        // --- CORRE√á√ÉO IMPRESS√ÉO RELAT√ìRIO ---
        window.imprimirRelatorio = () => {
            document.body.classList.add('printing-report');
            window.print();
            setTimeout(() => document.body.classList.remove('printing-report'), 1000);
        };

        window.gerarRelatorioFaltas = async () => {
            const mesAno = document.getElementById('mes-relatorio').value; 
            if(!mesAno) return alert("Selecione o m√™s.");
            const divRes = document.getElementById('resultado-relatorio');
            divRes.innerHTML = "Calculando...";
            loading(true);
            try {
                const start = mesAno + "-01";
                const end = mesAno + "-31";
                const q = query(
                    collection(db, "frequencia"), 
                    where("turma", "==", usuarioAtual.turma),
                    where("data", ">=", start),
                    where("data", "<=", end)
                );
                const snap = await getDocs(q);
                let mapaFaltas = {};
                
                listaAlunosCache.forEach(a => mapaFaltas[a.nome] = 0);
                
                let diasLetivos = 0;
                snap.forEach(docSnap => {
                    diasLetivos++;
                    const dados = docSnap.data();
                    if(dados.detalhes) {
                        dados.detalhes.forEach(d => {
                            if(mapaFaltas[d.nome] === undefined) mapaFaltas[d.nome] = 0; // Se aluno removido, adiciona
                            if(!d.presente) mapaFaltas[d.nome]++;
                        });
                    }
                });
                
                // Mapeia quem √© ex-aluno para exibir no relat√≥rio
                const nomesAtivos = listaAlunosCache.map(a => a.nome);

                const listaFinal = Object.entries(mapaFaltas).sort((a, b) => b[1] - a[1]);
                let html = `<div style="padding:10px;"><p><strong>Dias Letivos no M√™s:</strong> ${diasLetivos}</p>`;
                html += `<table class="desktop-table" style="width:100%; font-size:0.9rem; border:1px solid #ddd;">
                            <thead style="background:#eee; color:#333;"><tr><th>Aluno</th><th style="text-align:center">Faltas</th></tr></thead>
                            <tbody>`;
                listaFinal.forEach(([nome, faltas]) => {
                    const isEx = !nomesAtivos.includes(nome);
                    const nomeExibicao = isEx ? `${nome} <span class="texto-removido">(Ex-Aluno)</span>` : nome;
                    
                    const cor = faltas > 0 ? "color:#c0392b; font-weight:bold;" : "color:#27ae60;";
                    html += `<tr><td>${nomeExibicao}</td><td style="text-align:center; ${cor}">${faltas}</td></tr>`;
                });
                html += `</tbody></table></div>`;
                divRes.innerHTML = html;
            } catch(e) { console.error(e); divRes.innerHTML = "Erro ao gerar relat√≥rio."; } finally { loading(false); }
        };

        window.carregarPlanejamento = async () => {
            const dt = document.getElementById('data-plan').value;
            document.querySelectorAll('.input-plan').forEach(i => { i.value=""; i.disabled=true; });
            document.getElementById('btn-unlock').style.display='none';
            try {
                const s = await getDocs(query(collection(db,"planejamentos"), where("turma","==",usuarioAtual.turma), where("data","==",dt)));
                if(!s.empty) {
                    const d = s.docs[0].data();
                    document.getElementById('plan-disciplina').value = d.disciplina;
                    document.getElementById('plan-metodologia').value = d.metodologia;
                    document.getElementById('btn-unlock').style.display='inline-block';
                } else {
                    document.querySelectorAll('.input-plan').forEach(i => i.disabled=false);
                }
            } catch(e){}
        };

        window.salvarPlanejamento = async () => {
            loading(true);
            const dt = document.getElementById('data-plan').value;
            try {
                await setDoc(doc(db, "planejamentos", usuarioAtual.turma.replace(/\s/g,'')+"_"+dt), {
                    data: dt, turma: usuarioAtual.turma,
                    disciplina: document.getElementById('plan-disciplina').value,
                    metodologia: document.getElementById('plan-metodologia').value
                });
                alert("Di√°rio Salvo!"); window.carregarPlanejamento();
            } catch(e){ alert("Erro."); } finally { loading(false); }
        };

        window.excluirPlanejamento = async () => {
            if(!confirm("Excluir o registro deste dia?")) return;
            if(prompt("Senha Mestra:") !== SENHAS.EDICAO) return alert("Senha incorreta.");
            loading(true);
            try {
                await deleteDoc(doc(db, "planejamentos", usuarioAtual.turma.replace(/\s/g,'')+"_"+document.getElementById('data-plan').value));
                alert("Exclu√≠do."); window.carregarPlanejamento();
            } catch(e){ alert("Erro (talvez n√£o exista registro)."); } finally { loading(false); }
        };

        window.desbloquearEdicao = () => {
            if(prompt("Senha Mestra:") === SENHAS.EDICAO) {
                document.querySelectorAll('.input-plan').forEach(i => i.disabled=false);
                document.getElementById('btn-unlock').style.display='none';
            } else alert("Senha errada.");
        };

        window.validarAcessoCadastro = () => { if(prompt("Senha Admin:") === SENHAS.CADASTRO) window.showView('cadastro'); };
        window.abrirAreaAdmin = () => { if(prompt("Senha Secretaria:") === SENHAS.SECRETARIA) document.getElementById('modal-admin').style.display='flex'; };
        
        window.alternarTipoCadastro = () => {
            const t = document.getElementById('cad-tipo').value;
            document.getElementById('area-select-unica').classList.toggle('hidden', t !== 'professor');
            document.getElementById('area-select-coord').classList.toggle('hidden', t !== 'coordenador');
        };
        
        window.verificarPerfilCustomizado = () => {
            const val = document.getElementById('cad-perfil-coord').value;
            document.getElementById('container-checkboxes').classList.toggle('hidden', val !== 'CUSTOM');
        };

        function carregarOpcoesTurma() {
            const sel = document.getElementById('cad-turma-unica');
            const box = document.getElementById('container-checkboxes');
            for(const [g, ls] of Object.entries(ESTRUTURA_TURMAS)) {
                const og = document.createElement('optgroup'); og.label = g;
                ls.forEach(se => se.letras.forEach(l => {
                    const n = `${se.nome} ${l}`;
                    og.innerHTML += `<option value="${n}">${n}</option>`;
                    box.innerHTML += `<div><label><input type="checkbox" value="${n}" class="turma-check"> ${n}</label></div>`;
                }));
                sel.appendChild(og);
            }
        }

        window.fazerCadastro = async () => {
            const nome = document.getElementById('cad-nome').value;
            const email = document.getElementById('cad-email').value;
            const senha = document.getElementById('cad-senha').value;
            const tipo = document.getElementById('cad-tipo').value;
            let turma = "", acessos = [];
            if(tipo === 'professor') {
                turma = document.getElementById('cad-turma-unica').value;
                if(!turma) return alert("Escolha a turma.");
            } else {
                turma = "COORD";
                const perf = document.getElementById('cad-perfil-coord').value;
                if(!perf) return alert("Escolha o perfil.");
                if(perf === 'GERAL') acessos = ["TODAS"];
                else if(perf === 'CUSTOM') {
                    document.querySelectorAll('.turma-check:checked').forEach(c => acessos.push(c.value));
                    if(!acessos.length) return alert("Selecione turmas.");
                } else acessos = REGRAS_COORDENACAO[perf];
            }
            loading(true);
            try {
                await addDoc(collection(db, "professores"), { nome, email, senha, turma, acessos });
                alert("Criado!"); window.showView('login');
            } catch(e) { alert("Erro."); } finally { loading(false); }
        };

        window.importarAlunosMassa = async () => {
            const raw = document.getElementById('lista-alunos-massa').value;
            if(!raw.trim()) return alert("Cole a lista (Nome, Turma).");
            loading(true);
            const linhas = raw.split('\n');
            let count = 0;
            const promises = [];
            for(const l of linhas) {
                const parts = l.split(',');
                if(parts.length >= 2) {
                    const nome = parts[0].trim();
                    const turma = parts[1].trim(); 
                    if(nome && turma) {
                        promises.push(addDoc(collection(db, "alunos"), { nome, turma }));
                        count++;
                    }
                }
            }
            await Promise.all(promises);
            loading(false);
            alert(`${count} alunos importados com sucesso!`);
            document.getElementById('lista-alunos-massa').value = "";
        };

        window.removerDuplicados = async () => {
            if(!confirm("Isso ir√° verificar TODOS os alunos e apagar as duplicatas (mesmo nome e mesma turma). Deseja continuar?")) return;
            loading(true);
            try {
                const q = query(collection(db, "alunos"));
                const snap = await getDocs(q);
                const seen = new Set();
                const duplicates = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    const key = `${data.nome.trim().toLowerCase()}|${data.turma}`;
                    if (seen.has(key)) duplicates.push(doc.id);
                    else seen.add(key);
                });
                if (duplicates.length === 0) {
                    alert("Nenhuma duplicata encontrada.");
                } else {
                    const promises = duplicates.map(id => deleteDoc(doc(db, "alunos", id)));
                    await Promise.all(promises);
                    alert(`${duplicates.length} registros duplicados foram removidos!`);
                }
            } catch (e) {
                console.error(e);
                alert("Erro ao remover duplicados.");
            } finally { loading(false); }
        };

        window.limparBancoAlunos = async () => {
            if(!confirm("TEM CERTEZA? Isso apagar√° TODOS os alunos de TODAS as turmas.")) return;
            if(prompt("Digite a senha de Secretaria:") !== SENHAS.SECRETARIA) return alert("Senha errada.");
            loading(true);
            try {
                const q = query(collection(db, "alunos"));
                const snap = await getDocs(q);
                const promises = snap.docs.map(d => deleteDoc(doc(db, "alunos", d.id)));
                await Promise.all(promises);
                alert("Banco limpo!");
            } catch(e) { alert("Erro."); } finally { loading(false); }
        };

        window.processarImportacaoProfs = async () => {
            const raw = document.getElementById('lista-profs-import').value;
            loading(true);
            const linhas = raw.split('\n');
            for(const l of linhas) {
                const [n, t, e, s] = l.split(',').map(x=>x?.trim());
                if(n && t && e && s) await addDoc(collection(db, "professores"), { nome:n, turma:t, email:e, senha:s });
            }
            loading(false); alert("Professores criados."); document.getElementById('modal-admin').style.display='none';
        };

        window.abrirHistorico = async (tipo) => {
            document.getElementById('modal-historico').style.display = 'flex';
            const div = document.getElementById('modal-lista-conteudo');
            div.innerHTML = "Carregando...";
            const col = tipo === 'freq' ? "frequencia" : "planejamentos";
            const q = query(collection(db, col), where("turma", "==", usuarioAtual.turma));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(d => {
                const dd = d.data();
                html += `<div style="border-bottom:1px solid #eee; padding:10px; display:flex; justify-content:space-between;">
                            <span>${formatData(dd.data)}</span>
                            <button onclick="window.carregarDoHist('${dd.data}', '${tipo}')" style="background:var(--primary); color:white; border:none; border-radius:4px; padding:5px 10px;">Ver</button>
                         </div>`;
            });
            div.innerHTML = html || "Nenhum registro encontrado.";
        };

        window.carregarDoHist = (data, tipo) => {
            document.getElementById('modal-historico').style.display = 'none';
            document.getElementById(tipo === 'freq' ? 'data-freq' : 'data-plan').value = data;
            if(tipo === 'freq') window.carregarFrequencia();
            else window.carregarPlanejamento();
        };
        window.fecharHistorico = () => document.getElementById('modal-historico').style.display = 'none';

        window.imprimirTela = (tipo) => {
            document.body.classList.remove('printing-report');
            document.getElementById('p-turma').innerText = usuarioAtual.turma;
            document.getElementById('p-data').innerText = formatData(document.getElementById(tipo==='freq'?'data-freq':'data-plan').value);
            window.print();
        };

        window.removerAluno = async (id) => {
            if(confirm("Remover aluno permanentemente?")) {
                await deleteDoc(doc(db, "alunos", id));
                window.carregarAlunosBase().then(() => window.carregarFrequencia());
            }
        };
    </script>
</body>
</html>

