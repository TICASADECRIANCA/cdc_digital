<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASA+ - Sistema Online</title>
    <style>
        /* --- CSS GERAL --- */
        :root { --primary: #004aad; --sec: #0097b2; --bg: #f4f6f8; --text: #333; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* --- TELA DE LOGIN COM FUNDO --- */
        .auth-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            width: 100%;
            /* Fundo com imagem e uma m√°scara escura (0.6) para melhorar leitura */
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fundo_escola.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .card { 
            background: rgba(255, 255, 255, 0.95); /* Leve transpar√™ncia para integrar com o fundo */
            padding: 2.5rem; 
            border-radius: 12px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            width: 400px; 
            text-align: center; 
        }

        h2 { color: var(--primary); margin-bottom: 10px; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        /* Campo desabilitado visualmente */
        input:disabled, textarea:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; border: 1px dashed #ccc; }
        
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; font-size: 1rem; }
        button:hover { filter: brightness(90%); }
        .secondary-btn { background: #7f8c8d; }
        .success-btn { background: var(--success); }
        .warning-btn { background: var(--warning); color: white; }
        .link-text { margin-top: 15px; font-size: 0.9rem; color: #666; cursor: pointer; text-decoration: underline; }
        
        #app-painel { display: none; height: 100%; flex-direction: column; }
        header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); }
        .turma-badge { background: var(--sec); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-left: 15px; }
        
        .tabs { display: flex; justify-content: center; background: white; border-bottom: 1px solid #ddd; }
        .tab-btn { background: white; color: #7f8c8d; padding: 15px 40px; border-bottom: 4px solid transparent; width: auto; }
        .tab-btn.active { color: var(--primary); border-bottom: 4px solid var(--primary); background: #f9fbfd; }
        
        .main-content { padding: 2rem; max-width: 1000px; margin: 0 auto; width: 100%; overflow-y: auto; flex: 1; }
        .view-section { display: none; } 
        .view-section.active { display: block; }
        .import-area { background: #fff8e1; padding: 20px; border-radius: 8px; border: 1px solid #ffe082; display: none; margin-bottom: 20px; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; gap: 10px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        .status-btn { padding: 6px 16px; border-radius: 20px; border: none; cursor: pointer; color: white; font-weight: bold; width: 100px; }
        .presente { background: var(--success); }
        .ausente { background: var(--danger); opacity: 0.8; }

        .plan-card { background: white; padding: 30px; border-radius: 8px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; color: #555; }
        textarea { height: 80px; resize: vertical; border: 1px solid #ddd; background: #fafafa; line-height: 1.5; }

        /* Loader */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-size: 1.5rem; color: var(--primary); font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; }
        .hist-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }

        /* --- CSS DE IMPRESS√ÉO OTIMIZADO --- */
        @media print {
            body * { visibility: hidden; } /* Esconde tudo */
            
            /* Mostra apenas a aba ativa (seja Freq ou Plan) */
            .view-section.active, .view-section.active * { visibility: visible; }
            
            /* Posiciona a aba ativa no topo da folha */
            .view-section.active { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                padding: 0;
                margin: 0;
            }

            /* Esconde bot√µes de controle na impress√£o */
            button, .control-bar, header, .tabs, #area-importacao { display: none !important; }
            
            /* Ajustes do Planejamento para n√£o cortar margem */
            .plan-card { box-shadow: none; border: none; padding: 0; width: 100%; }
            textarea { 
                border: 1px solid #000; 
                background: white !important; 
                color: black;
                font-size: 11pt;
                font-family: 'Times New Roman', serif;
                width: 100%; 
                white-space: pre-wrap;
                overflow: visible;
                height: auto;
                min-height: 100px;
            }
            
            /* Tabela de Frequ√™ncia na impress√£o */
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; font-size: 10pt; color: black; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            .status-btn { border: 1px solid #000; color: black; background: white !important; }
        }
    </style>
</head>
<body>

    <div id="loader">Carregando...</div>

    <div id="view-login" class="auth-container">
        <div class="card">
            <h2>CASA+</h2>
            <p style="color: #777; margin-bottom: 20px;">Controle Acad√™mico de Sala de Aula</p>
            <p style="color: #777; margin-bottom: 20px;">Acesso Professor</p>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-senha" placeholder="Senha">
            <button onclick="window.fazerLogin()">Entrar</button>
            <p class="link-text" onclick="window.showView('cadastro')">Cadastrar novo professor</p>
        </div>
    </div>

    <div id="view-cadastro" class="auth-container" style="display: none;">
        <div class="card">
            <h2>Novo Cadastro</h2>
            <input type="text" id="cad-nome" placeholder="Nome Completo">
            <select id="cad-turma">
                <option value="" disabled selected>Selecione a Turma</option>
            </select>
            <input type="email" id="cad-email" placeholder="E-mail">
            <input type="password" id="cad-senha" placeholder="Senha">
            <button onclick="window.fazerCadastro()">Cadastrar</button>
            <button class="secondary-btn" onclick="window.showView('login')">Voltar</button>
        </div>
    </div>

    <div id="app-painel">
        <header>
            <div style="display: flex; align-items: center;">
                <span class="logo">CDC Digital</span>
                <span id="display-turma" class="turma-badge">...</span>
            </div>
            <button onclick="window.fazerLogout()" class="secondary-btn" style="width: auto; padding: 8px 20px; margin: 0;">Sair</button>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="window.mudarAba('freq')" id="btn-tab-freq">Frequ√™ncia</button>
            <button class="tab-btn" onclick="window.mudarAba('plan')" id="btn-tab-plan">Planejamento</button>
        </div>

        <div class="main-content">
            <div id="tab-freq" class="view-section active">
                <div class="control-bar">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: bold;">Data:</span>
                        <input type="date" id="data-freq" style="width: auto; margin: 0;" onchange="window.verificarChamadaDia()">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="window.salvarChamada()" class="success-btn" style="width: auto; margin: 0;">üíæ Salvar</button>
                        <button onclick="window.abrirHistorico('freq')" class="secondary-btn" style="width: auto; margin: 0;">üìÖ Hist√≥rico</button>
                        <button onclick="window.print()" style="background-color: #2c3e50; width: auto; margin: 0;">üñ®Ô∏è Imprimir Lista</button>
                    </div>
                </div>

                <div style="margin-bottom: 15px; text-align: right;">
                     <button onclick="window.toggleImport()" style="background: #f39c12; width: auto; font-size: 0.9rem; padding: 6px 15px;">üì• Importar Lista</button>
                </div>

                <div id="area-importacao" class="import-area">
                    <h4>Importa√ß√£o em Massa</h4>
                    <p>Cole: <strong>Nome, Turma</strong></p>
                    <textarea id="lista-import" rows="5" placeholder="Maria Silva, Infantil 1 A"></textarea>
                    <button onclick="window.processarImportacao()">Processar Lista</button>
                </div>
                
                <h3 style="display:none; text-align:center; margin-bottom:10px;" id="titulo-impressao-freq">Lista de Presen√ßa</h3>

                <table id="tabela-alunos">
                    <thead>
                        <tr>
                            <th>Aluno</th>
                            <th style="width: 150px; text-align: center;">Presen√ßa</th>
                            <th style="width: 50px; text-align: center;" class="no-print">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="lista-tbody"></tbody>
                </table>
                <p id="msg-vazia" style="text-align: center; color: #777; margin-top: 40px;">Carregando ou sem alunos...</p>
            </div>

            <div id="tab-plan" class="view-section">
                <div class="control-bar">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: bold;">Data:</span>
                        <input type="date" id="data-plan" style="width: auto; margin: 0;" onchange="window.carregarPlanejamento()">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="window.salvarPlanejamento()" class="success-btn" style="width: auto; margin: 0;">üíæ Salvar</button>
                        <button id="btn-editar-plan" onclick="window.desbloquearEdicao()" class="warning-btn" style="width: auto; margin: 0; display:none;">üîì Editar</button>
                        
                        <button onclick="window.abrirHistorico('plan')" class="secondary-btn" style="width: auto; margin: 0;">üìÖ Ver Salvos</button>
                        <button onclick="window.print()" style="background-color: #2c3e50; width: auto; margin: 0;">üñ®Ô∏è Imprimir</button>
                        <button onclick="window.limparTelaPlanejamento()" class="warning-btn" style="width: auto; margin: 0;">üóëÔ∏è Limpar Tela</button>
                    </div>
                </div>

                <div class="plan-card">
                    <h3 style="margin-top: 0; color: var(--primary);">Registro Di√°rio</h3>
                    <label>Componente Curricular / Disciplina:</label>
                    <input type="text" id="plan-disciplina" class="input-plan">
                    <label>Tema da Aula:</label>
                    <input type="text" id="plan-tema" class="input-plan">
                    <label>Objetivos de Aprendizagem (BNCC):</label>
                    <textarea id="plan-objetivos" class="input-plan"></textarea>
                    <label>Metodologia / Desenvolvimento:</label>
                    <textarea id="plan-metodologia" style="height: 120px;" class="input-plan"></textarea>
                    <label>Avalia√ß√£o / Observa√ß√µes:</label>
                    <textarea id="plan-avaliacao" class="input-plan"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-historico" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="modal-titulo">Hist√≥rico</h3>
                <button onclick="window.fecharHistorico()" style="width: auto; background: none; color: #333; font-size: 1.5rem; margin: 0;">&times;</button>
            </div>
            <div id="modal-lista"></div>
            <button onclick="window.fecharHistorico()" class="secondary-btn" style="margin-top: 20px;">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBjtXXfchJQO4vxeI_Vqw1QhV_1CLwB6jc",
            authDomain: "escoladigital-79997.firebaseapp.com",
            projectId: "escoladigital-79997",
            storageBucket: "escoladigital-79997.appspot.com",
            messagingSenderId: "system",
            appId: "system"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let usuarioAtual = null;
        let listaAlunosCache = [];
        const SENHA_EDICAO = "1234"; // Senha para editar

        const ESTRUTURA_TURMAS = {
            "Ensino Fundamental": [ { nome: "1¬∫ Ano", letras: ["A", "B", "C", "D", "I"] } ],
            "Educa√ß√£o Infantil": [
                { nome: "Ber√ß√°rio", letras: ["A"] },
                { nome: "Infantil 1", letras: ["A", "B", "C", "D", "E", "I"] },
                { nome: "Infantil 2", letras: ["A", "B", "C", "D", "E", "F", "G", "I", "J"] },
                { nome: "Infantil 3", letras: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"] },
                { nome: "Infantil 4", letras: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"] },
                { nome: "Infantil 5", letras: ["A", "B", "C", "D", "E", "F", "G", "I"] }
            ]
        };

        function loading(status) { document.getElementById('loader').style.display = status ? 'flex' : 'none'; }
        function formatarData(d) { if(!d) return ""; return d.split('-').reverse().join('/'); }

        window.onload = function() {
            carregarOpcoesTurma();
            const hoje = new Date().toISOString().split('T')[0];
            
            // Trava de Data
            const inputFreq = document.getElementById('data-freq');
            inputFreq.value = hoje;
            inputFreq.max = hoje;
            
            document.getElementById('data-plan').value = hoje;
        };

        window.verificarChamadaDia = async () => {
            const inputFreq = document.getElementById('data-freq');
            const dataSelecionada = inputFreq.value;
            const hoje = new Date().toISOString().split('T')[0];

            if (dataSelecionada > hoje) {
                alert("N√£o √© permitido preencher frequ√™ncia de datas futuras.");
                inputFreq.value = hoje;
                return window.verificarChamadaDia();
            }

            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.className = 'status-btn presente'; btn.innerText = 'Presente';
            });

            try {
                const docSnap = await getDocs(query(collection(db, "frequencia"), where("turma", "==", usuarioAtual.turma), where("data", "==", inputFreq.value)));
                if(!docSnap.empty) {
                    const dados = docSnap.docs[0].data();
                    const rows = document.querySelectorAll('#lista-tbody tr');
                    rows.forEach(row => {
                        const nome = row.cells[0].innerText;
                        const btn = row.cells[1].querySelector('button');
                        const info = dados.detalhes.find(d => d.nome === nome);
                        if(info) {
                            btn.className = info.presente ? 'status-btn presente' : 'status-btn ausente';
                            btn.innerText = info.presente ? 'Presente' : 'Ausente';
                        }
                    });
                }
            } catch(e) { console.log("Erro carregar freq", e); }
        }

        function carregarOpcoesTurma() {
            const select = document.getElementById('cad-turma');
            for (const [grupo, listaSeries] of Object.entries(ESTRUTURA_TURMAS)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = grupo;
                listaSeries.forEach(serie => {
                    serie.letras.forEach(letra => {
                        const option = document.createElement('option');
                        option.value = `${serie.nome} ${letra}`;
                        option.innerText = `${serie.nome} ${letra}`;
                        optgroup.appendChild(option);
                    });
                });
                select.appendChild(optgroup);
            }
        }

        window.showView = (view) => {
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-cadastro').style.display = 'none';
            document.getElementById('app-painel').style.display = 'none';
            if(view === 'login') document.getElementById('view-login').style.display = 'flex';
            if(view === 'cadastro') document.getElementById('view-cadastro').style.display = 'flex';
            if(view === 'app') document.getElementById('app-painel').style.display = 'flex';
        }

        window.mudarAba = (aba) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            document.getElementById('btn-tab-' + aba).classList.add('active');
        }

        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            loading(true);
            try {
                const q = query(collection(db, "professores"), where("email", "==", email), where("senha", "==", senha));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) alert("Dados incorretos.");
                else window.logar(querySnapshot.docs[0].data());
            } catch(e) { alert("Erro conex√£o."); } 
            finally { loading(false); }
        }

        window.fazerCadastro = async () => {
            const nome = document.getElementById('cad-nome').value;
            const turma = document.getElementById('cad-turma').value;
            const email = document.getElementById('cad-email').value;
            const senha = document.getElementById('cad-senha').value;
            if(!nome || !turma || !email || !senha) return alert("Preencha tudo!");
            loading(true);
            try {
                await addDoc(collection(db, "professores"), { nome, turma, email, senha });
                alert("Cadastrado!");
                window.logar({ nome, turma, email, senha });
            } catch(e) { alert("Erro."); }
            finally { loading(false); }
        }

        window.logar = async (user) => {
            usuarioAtual = user;
            document.getElementById('display-turma').innerText = `${user.turma} | ${user.nome}`;
            window.showView('app');
            await window.carregarAlunosNaTela();
            await window.carregarPlanejamento();
        }

        window.fazerLogout = () => { usuarioAtual = null; window.showView('login'); }

        window.carregarAlunosNaTela = async () => {
            loading(true);
            const tbody = document.getElementById('lista-tbody');
            tbody.innerHTML = "";
            try {
                const q = query(collection(db, "alunos"), where("turma", "==", usuarioAtual.turma));
                const snapshot = await getDocs(q);
                listaAlunosCache = [];
                snapshot.forEach(doc => listaAlunosCache.push({ id: doc.id, ...doc.data() }));
                listaAlunosCache.sort((a,b) => a.nome.localeCompare(b.nome));

                if(listaAlunosCache.length === 0) {
                    document.getElementById('msg-vazia').style.display = 'block';
                } else {
                    document.getElementById('msg-vazia').style.display = 'none';
                    listaAlunosCache.forEach(aluno => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${aluno.nome}</td>
                            <td style="text-align: center;"><button class="status-btn presente" onclick="window.toggleStatus(this)">Presente</button></td>
                            <td style="text-align: center;" class="no-print"><button style="border:none; background:none; cursor:pointer;" onclick="window.removerAluno('${aluno.id}')">üóëÔ∏è</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    await window.verificarChamadaDia();
                }
            } catch(e) { console.error(e); } finally { loading(false); }
        }

        window.toggleStatus = (btn) => {
            if(btn.classList.contains('presente')) {
                btn.classList.remove('presente'); btn.classList.add('ausente'); btn.innerText = "Ausente";
            } else {
                btn.classList.remove('ausente'); btn.classList.add('presente'); btn.innerText = "Presente";
            }
        }

        window.toggleImport = () => { const a = document.getElementById('area-importacao'); a.style.display = a.style.display==='none'?'block':'none'; }
        window.processarImportacao = async () => {
             const texto = document.getElementById('lista-import').value;
            if(!texto.trim()) return;
            loading(true);
            const linhas = texto.split('\n');
            const batchPromises = [];
            linhas.forEach(linha => {
                const p = linha.split(',');
                if(p.length >= 2) batchPromises.push(addDoc(collection(db, "alunos"), { nome: p[0].trim(), turma: p[1].trim() }));
            });
            await Promise.all(batchPromises);
            alert("Importado!");
            loading(false);
            window.carregarAlunosNaTela();
        }
        window.removerAluno = async (id) => { if(confirm("Remover?")) { await deleteDoc(doc(db, "alunos", id)); window.carregarAlunosNaTela(); } }

        window.salvarChamada = async () => {
            const data = document.getElementById('data-freq').value;
            const hoje = new Date().toISOString().split('T')[0];
            if(data > hoje) return alert("Data futura n√£o permitida!");

            const linhas = document.querySelectorAll('#lista-tbody tr');
            if(linhas.length === 0) return alert("Sem alunos.");
            loading(true);
            const idDoc = usuarioAtual.turma.replace(/\s/g, '') + "_" + data;
            
            const detalhes = [];
            let presentes = 0;
            linhas.forEach(tr => {
                const nome = tr.cells[0].innerText;
                const presente = tr.cells[1].querySelector('button').classList.contains('presente');
                if(presente) presentes++;
                detalhes.push({ nome, presente });
            });

            try {
                await setDoc(doc(db, "frequencia", idDoc), {
                    data, turma: usuarioAtual.turma, detalhes,
                    resumo: `${presentes} Presentes / ${linhas.length - presentes} Ausentes`
                });
                alert("Frequ√™ncia salva!");
            } catch(e) { alert("Erro ao salvar."); } finally { loading(false); }
        }

        window.carregarPlanejamento = async () => {
            const data = document.getElementById('data-plan').value;
            window.limparTelaPlanejamento(false);
            toggleCamposEdicao(true); 
            document.getElementById('btn-editar-plan').style.display = 'none';

            try {
                const docSnap = await getDocs(query(collection(db, "planejamentos"), where("turma", "==", usuarioAtual.turma), where("data", "==", data)));
                if(!docSnap.empty) {
                    const salvo = docSnap.docs[0].data();
                    document.getElementById('plan-disciplina').value = salvo.disciplina || "";
                    document.getElementById('plan-tema').value = salvo.tema || "";
                    document.getElementById('plan-objetivos').value = salvo.objetivos || "";
                    document.getElementById('plan-metodologia').value = salvo.metodologia || "";
                    document.getElementById('plan-avaliacao').value = salvo.avaliacao || "";
                    toggleCamposEdicao(false);
                    document.getElementById('btn-editar-plan').style.display = 'inline-block';
                } else {
                    toggleCamposEdicao(true); 
                }
            } catch(e) { toggleCamposEdicao(true); }
        }

        function toggleCamposEdicao(ativo) {
            const inputs = document.querySelectorAll('.input-plan');
            inputs.forEach(el => el.disabled = !ativo);
        }

        window.desbloquearEdicao = () => {
            const senha = prompt("Digite a senha para editar este planejamento:");
            if(senha === SENHA_EDICAO) {
                toggleCamposEdicao(true);
                document.getElementById('btn-editar-plan').style.display = 'none';
            } else {
                alert("Senha incorreta.");
            }
        }

        window.salvarPlanejamento = async () => {
            const data = document.getElementById('data-plan').value;
            const idDoc = usuarioAtual.turma.replace(/\s/g, '') + "_" + data;
            const plano = {
                data, turma: usuarioAtual.turma,
                disciplina: document.getElementById('plan-disciplina').value,
                tema: document.getElementById('plan-tema').value,
                objetivos: document.getElementById('plan-objetivos').value,
                metodologia: document.getElementById('plan-metodologia').value,
                avaliacao: document.getElementById('plan-avaliacao').value
            };
            loading(true);
            try {
                await setDoc(doc(db, "planejamentos", idDoc), plano);
                alert("Salvo!");
                toggleCamposEdicao(false);
                document.getElementById('btn-editar-plan').style.display = 'inline-block';
            } catch(e) { alert("Erro ao salvar."); } finally { loading(false); }
        }

        window.limparTelaPlanejamento = (confirmar = true) => {
            if(!confirmar || confirm("Limpar campos?")) {
                document.querySelectorAll('.input-plan').forEach(el => el.value = "");
                if(confirmar) {
                    toggleCamposEdicao(true);
                    document.getElementById('btn-editar-plan').style.display = 'none';
                }
            }
        }

        window.abrirHistorico = async (tipo) => {
            const modal = document.getElementById('modal-historico');
            const lista = document.getElementById('modal-lista');
            lista.innerHTML = "Carregando...";
            modal.style.display = 'flex';
            try {
                let colecao = tipo === 'freq' ? "frequencia" : "planejamentos";
                const q = query(collection(db, colecao), where("turma", "==", usuarioAtual.turma));
                const snapshot = await getDocs(q);
                const itens = [];
                snapshot.forEach(doc => itens.push(doc.data()));
                itens.sort((a,b) => new Date(b.data) - new Date(a.data));
                lista.innerHTML = "";
                if(itens.length === 0) lista.innerHTML = "<p>Nenhum registro.</p>";
                itens.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'hist-item';
                    const desc = tipo === 'freq' ? item.resumo : (item.tema || 'Sem tema');
                    div.innerHTML = `<span class="hist-date">${formatarData(item.data)}</span><span>${desc}</span><button onclick="window.carregarDataHistorico('${item.data}', '${tipo}')" style="width: auto; padding: 5px 10px;">Abrir</button>`;
                    lista.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }

        window.carregarDataHistorico = (data, tipo) => {
            window.fecharHistorico();
            if(tipo === 'freq') {
                document.getElementById('data-freq').value = data;
                window.verificarChamadaDia();
            } else {
                document.getElementById('data-plan').value = data;
                window.carregarPlanejamento();
            }
        }
        window.fecharHistorico = () => { document.getElementById('modal-historico').style.display = 'none'; }
    </script>
</body>
</html>
