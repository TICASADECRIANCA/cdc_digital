<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASA+ Gest√£o Escolar</title>
    <style>
        /* --- CSS GERAL --- */
        :root { --primary: #004aad; --sec: #0097b2; --bg: #f4f6f8; --text: #333; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        
        /* Ajuste de Abas para Separa√ß√£o Visual */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* LOGIN & CADASTRO */
        .auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; position: absolute; top:0; left:0; z-index: 10; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fundo_escola.jpg'); background-size: cover; }
        .card { background: rgba(255, 255, 255, 0.95); padding: 2.5rem; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 400px; text-align: center; max-height: 90vh; overflow-y: auto; }
        .logo-login { max-width: 150px; width: 100%; height: auto; margin-bottom: 15px; display: block; margin: 0 auto 15px auto; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; font-size: 1rem; }
        button:hover { filter: brightness(90%); }
        .secondary-btn { background: #7f8c8d; }
        .success-btn { background: var(--success); }
        .warning-btn { background: var(--warning); color: white; }
        .link-text { margin-top: 15px; font-size: 0.9rem; color: #666; cursor: pointer; text-decoration: underline; }

        /* PAINEL PRINCIPAL */
        #app-painel, #view-coord { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 0.8rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { height: 50px; width: auto; }
        .turma-badge { background: var(--sec); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .main-content { padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%; overflow-y: auto; flex: 1; }
        .tabs { display: flex; justify-content: center; background: white; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab-btn { background: white; color: #7f8c8d; padding: 15px 40px; border-bottom: 4px solid transparent; width: auto; cursor: pointer; border-radius: 0; margin-top: 0; }
        .tab-btn.active { color: var(--primary); border-bottom: 4px solid var(--primary); background: #f9fbfd; }

        .control-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; gap: 10px; flex-wrap: wrap; border: 1px solid #eee; }

        /* TABELAS */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        .status-btn { padding: 6px 16px; border-radius: 20px; border: none; cursor: pointer; color: white; font-weight: bold; width: 100px; }
        .presente { background: var(--success); }
        .ausente { background: var(--danger); opacity: 0.9; }

        .plan-card { background: white; padding: 30px; border-radius: 8px; border: 1px solid #eee; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; color: #555; }
        textarea { height: 80px; resize: vertical; border: 1px solid #ddd; background: #fafafa; line-height: 1.5; font-family: inherit; }

        /* GRID COORDENA√á√ÉO */
        .grid-turmas { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding: 10px; }
        .btn-turma { background: white; color: var(--primary); border: 2px solid var(--primary); padding: 15px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 110px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn-turma strong { font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .btn-turma span { font-size: 0.9rem; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; }
        .btn-turma:hover { background: var(--primary); color: white; transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .btn-turma:hover span { background: rgba(255,255,255,0.2); color: white; }

        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-size: 1.5rem; color: var(--primary); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; }
        
        @media print {
            @page { margin: 1cm; size: A4; }
            body, html { height: auto; overflow: visible; background: white; }
            #view-login, #view-cadastro, #view-coord, #app-painel, #loader, .modal-overlay, header, .tabs { display: none !important; }
            #print-container { display: block !important; width: 100%; font-family: 'Times New Roman', serif; color: black; }
            .print-header { border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
            .print-logo { height: 80px; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .print-table th, .print-table td { border: 1px solid black; padding: 6px; font-size: 11pt; }
            .print-block { margin-bottom: 20px; }
            .print-label { font-weight: bold; display: block; text-decoration: underline; }
            .print-text { display: block; border: 1px solid #ccc; padding: 10px; text-align: justify; white-space: pre-wrap; }
        }
    </style>
</head>
<body>

    <div id="loader">Carregando...</div>

    <div id="print-container" style="display:none;">
        <div class="print-header">
            <img src="logo.png" alt="Logo" class="print-logo">
            <div class="print-info">
                <h1 style="margin:0;">CASA+ Gest√£o Escolar</h1>
                <p><strong>Turma:</strong> <span id="p-turma"></span> | <strong>Prof:</strong> <span id="p-prof"></span></p>
                <p><strong>Data:</strong> <span id="p-data"></span></p>
            </div>
        </div>
        <div id="print-content-body"></div>
    </div>

    <div id="view-login" class="auth-container">
        <div class="card">
            <img src="logo.png" alt="Logo" class="logo-login">
            <p style="color: #777; margin-bottom: 20px;">Acesso Professor / Coordena√ß√£o</p>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-senha" placeholder="Senha">
            <button onclick="window.fazerLogin()">Entrar</button>
            <p class="link-text" onclick="window.validarAcessoCadastro()">Cadastrar Novo Usu√°rio</p>
            <p class="link-text" style="color: #999; font-size: 0.8rem; margin-top: 30px;" onclick="window.abrirAreaAdmin()">‚öôÔ∏è Secretaria</p>
        </div>
    </div>

    <div id="view-cadastro" class="auth-container hidden">
        <div class="card">
            <img src="logo.png" alt="Logo" class="logo-login">
            <h2>Novo Cadastro</h2>
            <input type="text" id="cad-nome" placeholder="Nome Completo">
            <input type="email" id="cad-email" placeholder="E-mail">
            <input type="password" id="cad-senha" placeholder="Senha">
            <label style="text-align:left; margin-top:10px; font-weight:bold;">Fun√ß√£o:</label>
            <select id="cad-tipo" onchange="window.alternarTipoCadastro()">
                <option value="professor">Professor (1 Turma)</option>
                <option value="coordenador">Coordenador / Gest√£o</option>
            </select>
            <div id="area-select-unica">
                <select id="cad-turma-unica"><option value="" disabled selected>Selecione a Turma</option></select>
            </div>
            <div id="area-select-coord" class="hidden" style="text-align: left;">
                <label style="margin-top:10px; display:block;">Perfil de Acesso:</label>
                <select id="cad-perfil-coord" onchange="window.verificarPerfilCustomizado()">
                    <option value="" disabled selected>Selecione o Coordenador...</option>
                    <option value="GERAL">Dire√ß√£o Geral (Todas as Turmas)</option>
                    <option value="CRISTIANE">Cristiane (Ber√ß√°rio e Infantil 1)</option>
                    <option value="ADNA">Adna (Infantil 2 - Manh√£/Tarde)</option>
                    <option value="NAYARA">Nayara (Infantil 3 - Manh√£)</option>
                    <option value="LUDMILLA">Ludmilla (Inf 3/4 Tarde, Inf 5, 1¬∫ Ano Tarde)</option>
                    <option value="ELIONEIDE">Elioneide (Infantil 4 - Manh√£)</option>
                    <option value="SAVIA">Savia (1¬∫ Ano - Manh√£)</option>
                    <option value="CUSTOM">Outro (Selecionar Manualmente)</option>
                </select>
                <div id="container-checkboxes" class="checklist-container hidden" style="margin-top:10px; max-height: 120px; overflow-y:auto; border:1px solid #ccc; padding:5px;"></div>
            </div>
            <button onclick="window.fazerCadastro()">Cadastrar</button>
            <button class="secondary-btn" onclick="window.showView('login')">Voltar</button>
        </div>
    </div>

    <div id="view-coord" class="hidden">
        <header>
            <div class="header-left"><img src="logo.png" class="header-logo"><span class="logo-text">Painel Coordena√ß√£o</span></div>
            <button onclick="window.fazerLogout()" class="secondary-btn" style="width:auto;">Sair</button>
        </header>
        <div class="main-content">
            <h3 style="color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px;">Turmas sob sua responsabilidade:</h3>
            <div id="container-turmas" class="grid-turmas"></div>
        </div>
    </div>

    <div id="app-painel" class="hidden">
        <header>
            <div class="header-left">
                <button id="btn-voltar-coord" onclick="window.voltarParaCoord()" style="display:none;margin-right:10px;background:#666;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">‚¨Ö Voltar</button>
                <img src="logo.png" class="header-logo"><span id="display-turma" class="turma-badge">...</span>
            </div>
            <button onclick="window.fazerLogout()" class="secondary-btn" style="width:auto;">Sair</button>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="window.mudarAba('freq')" id="btn-tab-freq">Frequ√™ncia</button>
            <button class="tab-btn" onclick="window.mudarAba('plan')" id="btn-tab-plan">Di√°rio de Classe</button>
            <button class="tab-btn" onclick="window.open('reunioes.html', '_blank')" style="color: #c0392b;">üìù Reuni√µes</button>
        </div>

        <div class="main-content">
            <div id="tab-freq" class="view-section active">
                <div class="control-bar">
                    <div>Data: <input type="date" id="data-freq" style="width:auto;" onchange="window.validarDataFrequencia()"></div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="window.salvarChamada()" class="success-btn" style="width:auto;">üíæ Salvar</button>
                        <button onclick="window.abrirHistorico('freq')" class="secondary-btn" style="width:auto;">üìÖ Hist√≥rico</button>
                        <button onclick="window.imprimirTela('freq')" style="background:#2c3e50; width:auto; color:white;">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>
                <div id="container-btn-import" style="display:none; text-align:right;"><button onclick="window.toggleImport()" style="background:var(--warning);width:auto;">üì• Importar Lista</button></div>
                <div id="area-importacao" class="import-area hidden">
                    <textarea id="lista-import" rows="3" placeholder="Cole nomes aqui..."></textarea>
                    <button onclick="window.processarImportacao()">Processar</button>
                </div>
                <table id="tabela-alunos">
                    <thead><tr><th style="width:50px;">N¬∫</th><th>Aluno</th><th style="text-align:center;">Presen√ßa</th><th class="no-print">A√ß√£o</th></tr></thead>
                    <tbody id="lista-tbody"></tbody>
                </table>
            </div>

            <div id="tab-plan" class="view-section">
                <div class="control-bar">
                    <div>Data: <input type="date" id="data-plan" style="width:auto;" onchange="window.carregarPlanejamento()"></div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="window.salvarPlanejamento()" class="success-btn" style="width:auto;">üíæ Salvar</button>
                        <button id="btn-editar-plan" onclick="window.desbloquearEdicao()" class="warning-btn" style="width:auto; display:none;">üîì Editar</button>
                        <button onclick="window.abrirHistorico('plan')" class="secondary-btn" style="width:auto;">üìÖ Ver Salvos</button>
                        <button onclick="window.imprimirTela('plan')" style="background:#2c3e50; width:auto; color:white;">üñ®Ô∏è Imprimir</button>
                        <button onclick="window.limparTelaPlanejamento()" class="warning-btn" style="width:auto;">üóëÔ∏è Limpar</button>
                    </div>
                </div>
                <div class="plan-card">
                    <h3 style="margin-top:0; color:var(--primary);">Registro Di√°rio</h3>
                    <label>Disciplina:</label><input type="text" id="plan-disciplina" class="input-plan">
                    <label>Tema:</label><input type="text" id="plan-tema" class="input-plan">
                    <label>Objetivos (BNCC):</label><textarea id="plan-objetivos" class="input-plan"></textarea>
                    <label>Metodologia:</label><textarea id="plan-metodologia" style="height:120px;" class="input-plan"></textarea>
                    <label>Avalia√ß√£o:</label><textarea id="plan-avaliacao" class="input-plan"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-historico" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between;"><h3>Hist√≥rico</h3><button onclick="window.fecharHistorico()" style="background:none;color:black;width:auto;">&times;</button></div>
            <div id="modal-lista"></div>
        </div>
    </div>
    <div id="modal-admin" class="modal-overlay">
        <div class="modal-content">
            <h3>Secretaria (Importa√ß√£o em Massa)</h3>
            <textarea id="lista-profs-import" rows="5" placeholder="Nome, Turma, Email, Senha"></textarea>
            <button onclick="window.processarImportacaoProfs()">Criar Contas</button>
            <button onclick="window.fecharAdmin()" class="secondary-btn">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjtXXfchJQO4vxeI_Vqw1QhV_1CLwB6jc", authDomain: "escoladigital-79997.firebaseapp.com", projectId: "escoladigital-79997", storageBucket: "escoladigital-79997.appspot.com", messagingSenderId: "system", appId: "system" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ESTRUTURA_TURMAS = { 
            "Ber√ß√°rio": [ { nome: "Ber√ß√°rio", letras: ["A"] } ],
            "Infantil 1": [ { nome: "Infantil 1", letras: ["A", "B", "C", "D", "E", "F", "G"] } ],
            "Infantil 2": [ { nome: "Infantil 2", letras: ["A", "B", "C", "D", "E", "F", "G", "I", "J"] } ], 
            "Infantil 3": [ { nome: "Infantil 3", letras: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"] } ], 
            "Infantil 4": [ { nome: "Infantil 4", letras: ["A", "B", "C", "D", "E", "F", "I", "J"] } ], 
            "Infantil 5": [ { nome: "Infantil 5", letras: ["A", "B", "C", "D", "E", "F", "G", "I"] } ],
            "Ensino Fundamental": [ { nome: "1¬∫ Ano", letras: ["A", "B", "C", "D", "I"] } ]
        };
        const REGRAS_COORDENACAO = {
            "CRISTIANE": ["Ber√ß√°rio A", "Infantil 1 A", "Infantil 1 B", "Infantil 1 C", "Infantil 1 D", "Infantil 1 E", "Infantil 1 F", "Infantil 1 G"],
            "ADNA": ["Infantil 2 A", "Infantil 2 B", "Infantil 2 C", "Infantil 2 D", "Infantil 2 E", "Infantil 2 F", "Infantil 2 G", "Infantil 2 I", "Infantil 2 J"],
            "NAYARA": ["Infantil 3 A", "Infantil 3 B", "Infantil 3 C", "Infantil 3 D", "Infantil 3 E", "Infantil 3 F", "Infantil 3 G", "Infantil 3 H"],
            "LUDMILLA": ["Infantil 3 I", "Infantil 3 J", "Infantil 4 I", "Infantil 4 J", "Infantil 5 A", "Infantil 5 B", "Infantil 5 C", "Infantil 5 D", "Infantil 5 E", "Infantil 5 F", "Infantil 5 G", "Infantil 5 I", "1¬∫ Ano I"],
            "ELIONEIDE": ["Infantil 4 A", "Infantil 4 B", "Infantil 4 C", "Infantil 4 D", "Infantil 4 E", "Infantil 4 F"],
            "SAVIA": ["1¬∫ Ano A", "1¬∫ Ano B", "1¬∫ Ano C", "1¬∫ Ano D"]
        };
        const SENHAS = { CADASTRO: "1992", SECRETARIA: "1992", EDICAO: "1992" };
        let usuarioAtual = null; let perfilCoord = null; let listaAlunosCache = [];

        function loading(status) { document.getElementById('loader').style.display = status ? 'flex' : 'none'; }
        function formatarData(d) { if(!d) return ""; return d.split('-').reverse().join('/'); }

        window.onload = function() {
            carregarOpcoesTurma();
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-freq').value = hoje;
            document.getElementById('data-freq').max = hoje; // Trava nativa para datas futuras
            document.getElementById('data-plan').value = hoje;
        };

        window.validarDataFrequencia = () => {
            const hoje = new Date().toISOString().split('T')[0];
            const dataSel = document.getElementById('data-freq').value;
            if (dataSel > hoje) {
                alert("N√£o √© permitido preencher frequ√™ncia em datas futuras.");
                document.getElementById('data-freq').value = hoje;
            }
            window.verificarChamadaDia();
        };

        window.mudarAba = (aba) => {
            document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            document.getElementById('btn-tab-' + aba).classList.add('active');
        };

        window.salvarChamada = async () => {
            const dt = document.getElementById('data-freq').value;
            const hoje = new Date().toISOString().split('T')[0];
            if(dt > hoje) return alert("Erro: Data futura detectada.");

            const linhas = document.querySelectorAll('#lista-tbody tr');
            if(!linhas.length) return alert("Sem alunos.");
            loading(true);
            const detalhes = []; let presentes = 0;
            linhas.forEach(tr => {
                const nome = tr.cells[1].innerText;
                const p = tr.cells[2].querySelector('button').classList.contains('presente');
                if(p) presentes++; detalhes.push({ nome, presente: p });
            });
            try {
                await setDoc(doc(db, "frequencia", usuarioAtual.turma.replace(/\s/g,'')+"_"+dt), { data:dt, turma: usuarioAtual.turma, detalhes, resumo: `${presentes} Presentes / ${linhas.length-presentes} Faltas` });
                alert("Chamada Salva!");
            } catch(e) { alert("Erro ao salvar."); } finally { loading(false); }
        };

        // --- RESTANTE DAS FUN√á√ïES (Mantidas do original conforme sua l√≥gica) ---
        window.validarAcessoCadastro = () => { if(prompt("Senha:") === SENHAS.CADASTRO) window.showView('cadastro'); else alert("Senha incorreta."); }
        window.alternarTipoCadastro = () => { const t = document.getElementById('cad-tipo').value; document.getElementById('area-select-unica').classList.toggle('hidden', t !== 'professor'); document.getElementById('area-select-coord').classList.toggle('hidden', t !== 'coordenador'); }
        window.verificarPerfilCustomizado = () => { const perfil = document.getElementById('cad-perfil-coord').value; const checkContainer = document.getElementById('container-checkboxes'); if (perfil === 'CUSTOM') checkContainer.classList.remove('hidden'); else checkContainer.classList.add('hidden'); }
        
        function carregarOpcoesTurma() {
            const s = document.getElementById('cad-turma-unica'); const c = document.getElementById('container-checkboxes');
            for (const [g, ls] of Object.entries(ESTRUTURA_TURMAS)) {
                const og = document.createElement('optgroup'); og.label = g;
                const dg = document.createElement('div'); dg.innerHTML=`<strong style='display:block;margin-top:5px;color:#004aad'>${g}</strong>`; c.appendChild(dg);
                ls.forEach(se => se.letras.forEach(l => {
                    const n = `${se.nome} ${l}`;
                    const o = document.createElement('option'); o.value=n; o.innerText=n; og.appendChild(o);
                    const dc = document.createElement('div'); dc.className='check-item'; dc.innerHTML=`<label><input type="checkbox" value="${n}" class="turma-check"> ${n}</label>`; c.appendChild(dc);
                }));
                s.appendChild(og);
            }
        }

        window.fazerCadastro = async () => {
            const n=document.getElementById('cad-nome').value, e=document.getElementById('cad-email').value, s=document.getElementById('cad-senha').value, t=document.getElementById('cad-tipo').value;
            let tf="", ac=[];
            if(t==='professor') { tf=document.getElementById('cad-turma-unica').value; if(!tf) return alert("Selecione turma"); } 
            else { tf="COORD"; const perfil = document.getElementById('cad-perfil-coord').value; if (!perfil) return alert("Selecione o perfil.");
                if (perfil === 'GERAL') ac = ["TODAS"]; else if (perfil === 'CUSTOM') { document.querySelectorAll('.turma-check:checked').forEach(x=>ac.push(x.value)); if(!ac.length) return alert("Selecione uma turma."); }
                else ac = REGRAS_COORDENACAO[perfil];
            }
            loading(true); try { await addDoc(collection(db,"professores"),{nome:n, turma:tf, acessos:ac, email:e, senha:s}); alert("Usu√°rio Cadastrado!"); window.showView('login'); } catch(x){alert("Erro");} finally{loading(false);}
        }

        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value; const senha = document.getElementById('login-senha').value;
            loading(true); try { const q = query(collection(db, "professores"), where("email", "==", email), where("senha", "==", senha)); const snap = await getDocs(q); if(snap.empty) alert("Login inv√°lido."); else window.logar(snap.docs[0].data()); } catch(e) { alert("Erro de conex√£o."); } finally { loading(false); }
        }

        window.logar = (user) => { if (user.turma === "COORD" || (user.acessos && user.acessos.length > 0)) { usuarioAtual = user; perfilCoord = user; window.showView('coord'); window.renderizarPainelCoord(user.acessos || []); } else { usuarioAtual = user; perfilCoord = null; document.getElementById('btn-voltar-coord').style.display = 'none'; window.abrirPainelTurma(user.turma, user.nome); } }

        window.renderizarPainelCoord = (acessos) => {
            const ct = document.getElementById('container-turmas'); ct.innerHTML=""; const isGeral = acessos.includes("TODAS");
            for (const [g, ls] of Object.entries(ESTRUTURA_TURMAS)) { ls.forEach(se => se.letras.forEach(l => { const n = `${se.nome} ${l}`; if(isGeral || acessos.includes(n)) { const b=document.createElement('div'); b.className='btn-turma'; b.innerHTML=`<strong>${se.nome}</strong><span>Turma ${l}</span>`; b.onclick=()=>window.entrarComoCoord(n); ct.appendChild(b); } })); }
        }

        window.entrarComoCoord = (t) => { usuarioAtual = {nome: perfilCoord.nome+" (Coord)", turma: t}; document.getElementById('btn-voltar-coord').style.display='inline-block'; window.abrirPainelTurma(t, usuarioAtual.nome); }
        window.voltarParaCoord = () => { usuarioAtual=perfilCoord; window.showView('coord'); }
        window.showView = (v) => { ['view-login','view-cadastro','app-painel','view-coord'].forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById(v==='login'?'view-login': v==='cadastro'?'view-cadastro': v==='app'?'app-painel':'view-coord').classList.remove('hidden'); if(v==='app') document.getElementById('app-painel').style.display = 'flex'; if(v==='coord') document.getElementById('view-coord').style.display = 'flex'; }
        window.abrirPainelTurma = async (turma, nome) => { document.getElementById('display-turma').innerText = `${turma} | ${nome}`; document.getElementById('container-btn-import').style.display = perfilCoord ? 'block' : 'none'; window.showView('app'); await window.carregarAlunosNaTela(); await window.carregarPlanejamento(); }
        
        window.carregarAlunosNaTela = async () => {
            loading(true); const tbody = document.getElementById('lista-tbody'); tbody.innerHTML = "";
            try { const snap = await getDocs(query(collection(db, "alunos"), where("turma", "==", usuarioAtual.turma))); listaAlunosCache = []; snap.forEach(d => listaAlunosCache.push({ id: d.id, ...d.data() })); listaAlunosCache.sort((a,b) => a.nome.localeCompare(b.nome));
                listaAlunosCache.forEach((aluno, index) => { const tr = document.createElement('tr'); const btnDel = perfilCoord ? `<button onclick="window.removerAluno('${aluno.id}')" style="background:none;color:red;border:none;cursor:pointer;">üóëÔ∏è</button>` : ''; tr.innerHTML = `<td style="text-align:center">${index+1}</td><td>${aluno.nome}</td><td style="text-align:center;"><button class="status-btn presente" onclick="window.toggleStatus(this)">Presente</button></td><td class="no-print" style="text-align:center;">${btnDel}</td>`; tbody.appendChild(tr); }); await window.verificarChamadaDia();
            } catch(e){} finally { loading(false); }
        }

        window.toggleStatus = (btn) => { if(btn.classList.contains('presente')) { btn.className = 'status-btn ausente'; btn.innerText = "Ausente"; } else { btn.className = 'status-btn presente'; btn.innerText = "Presente"; } }
        window.verificarChamadaDia = async () => {
            const dt = document.getElementById('data-freq').value; document.querySelectorAll('.status-btn').forEach(b => { b.className = 'status-btn presente'; b.innerText = 'Presente'; });
            try { const snap = await getDocs(query(collection(db, "frequencia"), where("turma", "==", usuarioAtual.turma), where("data", "==", dt))); if(!snap.empty) { const d = snap.docs[0].data(); document.querySelectorAll('#lista-tbody tr').forEach(row => { const nome = row.cells[1].innerText; const info = d.detalhes.find(x => x.nome === nome); if(info) { const btn = row.cells[2].querySelector('button'); btn.className = info.presente ? 'status-btn presente' : 'status-btn ausente'; btn.innerText = info.presente ? 'Presente' : 'Ausente'; } }); } } catch(e){}
        }

        window.carregarPlanejamento = async () => {
            const dt = document.getElementById('data-plan').value; window.limparTelaPlanejamento(false);
            try { const s = await getDocs(query(collection(db,"planejamentos"),where("turma","==",usuarioAtual.turma),where("data","==",dt)));
                if(!s.empty) { const d = s.docs[0].data(); document.getElementById('plan-disciplina').value = d.disciplina||""; document.getElementById('plan-tema').value = d.tema||""; document.getElementById('plan-objetivos').value = d.objetivos||""; document.getElementById('plan-metodologia').value = d.metodologia||""; document.getElementById('plan-avaliacao').value = d.avaliacao||""; toggleCamposEdicao(false); document.getElementById('btn-editar-plan').style.display='inline-block'; }
            } catch(e){}
        }
        function toggleCamposEdicao(ativo) { document.querySelectorAll('.input-plan').forEach(x => x.disabled = !ativo); }
        window.desbloquearEdicao = () => { if(prompt("Senha:") === SENHAS.EDICAO) { toggleCamposEdicao(true); document.getElementById('btn-editar-plan').style.display='none'; } else alert("Senha errada"); }
        window.salvarPlanejamento = async () => {
            loading(true); try { const dt = document.getElementById('data-plan').value; await setDoc(doc(db,"planejamentos",usuarioAtual.turma.replace(/\s/g,'')+"_"+dt), { data: dt, turma: usuarioAtual.turma, disciplina: document.getElementById('plan-disciplina').value, tema: document.getElementById('plan-tema').value, objetivos: document.getElementById('plan-objetivos').value, metodologia: document.getElementById('plan-metodologia').value, avaliacao: document.getElementById('plan-avaliacao').value }); alert("Planejamento Salvo!"); toggleCamposEdicao(false); document.getElementById('btn-editar-plan').style.display='inline-block'; } catch(e){ alert("Erro ao salvar."); } finally { loading(false); }
        }
        window.limparTelaPlanejamento = (conf=true) => { if(!conf || confirm("Limpar tela?")) { document.querySelectorAll('.input-plan').forEach(e=>e.value=""); toggleCamposEdicao(true); document.getElementById('btn-editar-plan').style.display='none'; } }

        window.imprimirTela = (tipo) => {
            document.getElementById('p-turma').innerText = usuarioAtual.turma; document.getElementById('p-prof').innerText = usuarioAtual.nome; const dt = tipo === 'freq' ? document.getElementById('data-freq').value : document.getElementById('data-plan').value; document.getElementById('p-data').innerText = formatarData(dt);
            const corpo = document.getElementById('print-content-body'); corpo.innerHTML = "";
            if (tipo === 'plan') {
                const campos = [{ label: "Disciplina", val: document.getElementById('plan-disciplina').value }, { label: "Tema", val: document.getElementById('plan-tema').value }, { label: "Objetivos", val: document.getElementById('plan-objetivos').value }, { label: "Metodologia", val: document.getElementById('plan-metodologia').value }, { label: "Avalia√ß√£o", val: document.getElementById('plan-avaliacao').value }];
                campos.forEach(c => { const div = document.createElement('div'); div.className = 'print-block'; div.innerHTML = `<span class="print-label">${c.label}:</span><span class="print-text">${c.val || '---'}</span>`; corpo.appendChild(div); });
            } else {
                const table = document.createElement('table'); table.className = 'print-table'; table.innerHTML = `<thead><tr><th width="5%">N¬∫</th><th>Aluno</th><th width="20%">Presen√ßa</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody');
                document.querySelectorAll('#lista-tbody tr').forEach(tr => { const row = document.createElement('tr'); row.innerHTML = `<td style="text-align:center">${tr.cells[0].innerText}</td><td>${tr.cells[1].innerText}</td><td style="text-align:center;font-weight:bold;">${tr.querySelector('.presente')?'P':'F'}</td>`; tbody.appendChild(row); }); corpo.appendChild(table);
            }
            window.print();
        }

        window.abrirAreaAdmin = () => { if(prompt("Senha Admin:") === SENHAS.SECRETARIA) document.getElementById('modal-admin').style.display='flex'; }
        window.fecharAdmin = () => document.getElementById('modal-admin').style.display='none';
        window.abrirHistorico = async(t) => {
            document.getElementById('modal-historico').style.display='flex'; document.getElementById('modal-lista').innerHTML="Carregando..."; const s = await getDocs(query(collection(db, t==='freq'?"frequencia":"planejamentos"), where("turma","==",usuarioAtual.turma))); let html = "";
            s.forEach(d => { const dt = d.data(); html += `<div class="hist-item" style="margin-bottom:10px;"><span>${formatarData(dt.data)}</span> <button onclick="window.carregarHist('${dt.data}','${t}')" style="padding:5px; width:auto; margin-left:10px;">Ver</button></div>`; }); document.getElementById('modal-lista').innerHTML = html || "Nada encontrado.";
        }
        window.fecharHistorico = () => document.getElementById('modal-historico').style.display='none';
        window.carregarHist = (d, t) => { window.fecharHistorico(); document.getElementById(t==='freq'?'data-freq':'data-plan').value = d; if(t==='freq') window.verificarChamadaDia(); else window.carregarPlanejamento(); }
        window.toggleImport = () => { document.getElementById('area-importacao').classList.toggle('hidden'); }
        window.processarImportacao = async () => { const nomes = document.getElementById('lista-import').value.split('\n'); loading(true); for(let n of nomes) { if(n.trim()) await addDoc(collection(db,"alunos"), {nome:n.split(',')[0], turma: usuarioAtual.turma}); } loading(false); alert("Importado!"); window.carregarAlunosNaTela(); }
        window.removerAluno = async (id) => { if(confirm("Apagar aluno?")) { await deleteDoc(doc(db,"alunos",id)); window.carregarAlunosNaTela(); }}
        window.processarImportacaoProfs=async()=>{const t=document.getElementById('lista-profs-import').value; if(!t.trim())return; loading(true); const p=[]; t.split('\n').forEach(l=>{const [n,tr,e,s]=l.split(',').map(x=>x?.trim()); if(n&&tr&&e&&s)p.push(addDoc(collection(db,"professores"),{nome:n,turma:tr,email:e,senha:s}));}); await Promise.all(p); alert("Feito!"); loading(false); window.fecharAdmin();}
        window.fazerLogout = () => { usuarioAtual=null; window.showView('login'); }
    </script>
</body>
</html>

