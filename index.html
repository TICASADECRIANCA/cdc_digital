<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASA+ - Gest√£o Escolar</title>
    <style>
        /* --- CSS GERAL --- */
        :root { --primary: #004aad; --sec: #0097b2; --bg: #f4f6f8; --text: #333; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* --- TELA DE LOGIN --- */
        .auth-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            width: 100%;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fundo_escola.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .card { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 2.5rem; 
            border-radius: 12px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            width: 400px; 
            text-align: center; 
        }

        .logo-login {
            max-width: 150px;
            width: 100%;
            height: auto;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        h2 { color: var(--primary); margin-bottom: 10px; margin-top: 0; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; font-size: 1rem; }
        button:hover { filter: brightness(90%); }
        .secondary-btn { background: #7f8c8d; }
        .success-btn { background: var(--success); }
        .warning-btn { background: var(--warning); color: white; }
        .link-text { margin-top: 15px; font-size: 0.9rem; color: #666; cursor: pointer; text-decoration: underline; }

        /* --- PAINEL COORDENA√á√ÉO --- */
        #view-coord { display: none; padding: 2rem; max-width: 1000px; margin: 0 auto; width: 100%; }
        .grid-turmas { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .btn-turma { background: white; color: var(--primary); border: 2px solid var(--primary); padding: 20px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; }
        .btn-turma:hover { background: var(--primary); color: white; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .grupo-titulo { grid-column: 1 / -1; margin-top: 20px; border-bottom: 2px solid #ddd; padding-bottom: 5px; color: #555; }
        
        /* --- PAINEL PROFESSOR --- */
        #app-painel { display: none; height: 100%; flex-direction: column; }
        header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); }
        .turma-badge { background: var(--sec); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-left: 15px; }
        
        .tabs { display: flex; justify-content: center; background: white; border-bottom: 1px solid #ddd; }
        .tab-btn { background: white; color: #7f8c8d; padding: 15px 40px; border-bottom: 4px solid transparent; width: auto; }
        .tab-btn.active { color: var(--primary); border-bottom: 4px solid var(--primary); background: #f9fbfd; }
        
        .main-content { padding: 2rem; max-width: 1000px; margin: 0 auto; width: 100%; overflow-y: auto; flex: 1; }
        .view-section { display: none; } 
        .view-section.active { display: block; }
        .import-area { background: #fff8e1; padding: 20px; border-radius: 8px; border: 1px solid #ffe082; display: none; margin-bottom: 20px; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; gap: 10px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        .status-btn { padding: 6px 16px; border-radius: 20px; border: none; cursor: pointer; color: white; font-weight: bold; width: 100px; }
        .presente { background: var(--success); }
        .ausente { background: var(--danger); opacity: 0.8; }

        .plan-card { background: white; padding: 30px; border-radius: 8px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; color: #555; }
        textarea { height: 80px; resize: vertical; border: 1px solid #ddd; background: #fafafa; line-height: 1.5; }

        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-size: 1.5rem; color: var(--primary); font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; }
        .hist-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }

        @media print {
            body * { visibility: hidden; }
            .view-section.active, .view-section.active * { visibility: visible; }
            .view-section.active { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
            button, .control-bar, header, .tabs, #area-importacao { display: none !important; }
            .plan-card { box-shadow: none; border: none; padding: 0; width: 100%; }
            textarea { border: 1px solid #000; background: white !important; color: black; font-size: 11pt; font-family: 'Times New Roman', serif; width: 100%; white-space: pre-wrap; overflow: visible; height: auto; min-height: 100px; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; font-size: 10pt; color: black; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            .status-btn { border: 1px solid #000; color: black; background: white !important; }
        }
    </style>
</head>
<body>

    <div id="loader">Carregando...</div>

    <div id="view-login" class="auth-container">
        <div class="card">
            <img src="logo.png" alt="Logo Escola" class="logo-login">
            <h2>CASA+</h2>
            <p style="color: #777; margin-bottom: 20px;">Acesso Restrito</p>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-senha" placeholder="Senha">
            <button onclick="window.fazerLogin()">Entrar</button>
            <p class="link-text" onclick="window.showView('cadastro')">Cadastrar Professor</p>
            <p class="link-text" style="color: #999; font-size: 0.8rem; margin-top: 30px;" onclick="window.abrirAreaAdmin()">‚öôÔ∏è Secretaria (Gest√£o de Acessos)</p>
        </div>
    </div>

    <div id="view-cadastro" class="auth-container" style="display: none;">
        <div class="card">
            <img src="logo.png" alt="Logo Escola" class="logo-login">
            <h2>Novo Cadastro</h2>
            <input type="text" id="cad-nome" placeholder="Nome Completo">
            <select id="cad-turma">
                <option value="" disabled selected>Selecione Turma ou Cargo</option>
            </select>
            <input type="email" id="cad-email" placeholder="E-mail">
            <input type="password" id="cad-senha" placeholder="Senha">
            <button onclick="window.fazerCadastro()">Cadastrar</button>
            <button class="secondary-btn" onclick="window.showView('login')">Voltar</button>
        </div>
    </div>

    <div id="view-coord">
        <header style="border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center;">
                <span class="logo" style="font-weight: bold; font-size: 1.2rem;">Painel Coordena√ß√£o</span>
                <span id="coord-badge" class="turma-badge" style="background: var(--primary);">Geral</span>
            </div>
            <button onclick="window.fazerLogout()" class="secondary-btn" style="width: auto; padding: 8px 20px; margin: 0;">Sair</button>
        </header>

        <h3 style="color: #555;">Selecione uma turma para gerenciar:</h3>
        <div id="container-turmas" class="grid-turmas">
            </div>
    </div>

    <div id="app-painel">
        <header>
            <div style="display: flex; align-items: center;">
                <button id="btn-voltar-coord" onclick="window.voltarParaCoord()" style="display:none; width: auto; padding: 5px 15px; margin-right: 15px; background: #666;">‚¨Ö Voltar</button>
                <span class="logo">CDC Digital</span>
                <span id="display-turma" class="turma-badge">...</span>
            </div>
            <button onclick="window.fazerLogout()" class="secondary-btn" style="width: auto; padding: 8px 20px; margin: 0;">Sair</button>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="window.mudarAba('freq')" id="btn-tab-freq">Frequ√™ncia</button>
            <button class="tab-btn" onclick="window.mudarAba('plan')" id="btn-tab-plan">Planejamento</button>
        </div>

        <div class="main-content">
            <div id="tab-freq" class="view-section active">
                <div class="control-bar">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>Data:</span>
                        <input type="date" id="data-freq" style="width: auto; margin: 0;" onchange="window.verificarChamadaDia()">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="window.salvarChamada()" class="success-btn" style="width: auto;">üíæ Salvar</button>
                        <button onclick="window.abrirHistorico('freq')" class="secondary-btn" style="width: auto;">üìÖ Hist√≥rico</button>
                        <button onclick="window.print()" style="background: #2c3e50; width: auto;">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>

                <div style="margin-bottom: 15px; text-align: right;">
                     <button onclick="window.toggleImport()" style="background: #f39c12; width: auto; font-size: 0.9rem; padding: 6px 15px;">üì• Importar Lista</button>
                </div>
                <div id="area-importacao" class="import-area">
                    <textarea id="lista-import" rows="5" placeholder="Maria Silva, Infantil 1 A"></textarea>
                    <button onclick="window.processarImportacao()">Processar Lista</button>
                </div>
                
                <table id="tabela-alunos">
                    <thead><tr><th>Aluno</th><th style="text-align: center;">Presen√ßa</th><th style="text-align: center;" class="no-print">A√ß√£o</th></tr></thead>
                    <tbody id="lista-tbody"></tbody>
                </table>
                <p id="msg-vazia" style="text-align: center; color: #777; margin-top: 40px;">Carregando...</p>
            </div>

            <div id="tab-plan" class="view-section">
                <div class="control-bar">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>Data:</span>
                        <input type="date" id="data-plan" style="width: auto; margin: 0;" onchange="window.carregarPlanejamento()">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="window.salvarPlanejamento()" class="success-btn" style="width: auto;">üíæ Salvar</button>
                        <button id="btn-editar-plan" onclick="window.desbloquearEdicao()" class="warning-btn" style="width: auto; display:none;">üîì Editar</button>
                        <button onclick="window.abrirHistorico('plan')" class="secondary-btn" style="width: auto;">üìÖ Ver Salvos</button>
                        <button onclick="window.print()" style="background: #2c3e50; width: auto;">üñ®Ô∏è Imprimir</button>
                        <button onclick="window.limparTelaPlanejamento()" class="warning-btn" style="width: auto;">üóëÔ∏è Limpar</button>
                    </div>
                </div>
                <div class="plan-card">
                    <h3 style="margin-top: 0; color: var(--primary);">Registro Di√°rio</h3>
                    <label>Componente Curricular / Disciplina:</label><input type="text" id="plan-disciplina" class="input-plan">
                    <label>Tema da Aula:</label><input type="text" id="plan-tema" class="input-plan">
                    <label>Objetivos (BNCC):</label><textarea id="plan-objetivos" class="input-plan"></textarea>
                    <label>Metodologia:</label><textarea id="plan-metodologia" style="height: 120px;" class="input-plan"></textarea>
                    <label>Avalia√ß√£o:</label><textarea id="plan-avaliacao" class="input-plan"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-historico" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between;"><h3>Hist√≥rico</h3><button onclick="window.fecharHistorico()" style="width:auto; background:none; color:black;">&times;</button></div>
            <div id="modal-lista"></div>
            <button onclick="window.fecharHistorico()" class="secondary-btn">Fechar</button>
        </div>
    </div>

    <div id="modal-admin" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between;"><h3>Secretaria - Acessos</h3><button onclick="window.fecharAdmin()" style="width:auto; background:none; color:black;">&times;</button></div>
            <div class="import-area" style="display: block; background: #e3f2fd; border-color: #90caf9;">
                <p><strong>Formato de Importa√ß√£o:</strong></p>
                <p>Nome, Turma/Cargo, Email, Senha</p>
                <p style="font-size: 0.8rem; color: #555;">
                    Ex. Professor: <code>Ana, Infantil 1 A, ana@x.com, 123</code><br>
                    Ex. Coord N√≠vel: <code>Bia, Educa√ß√£o Infantil, bia@x.com, 123</code><br>
                    Ex. Coord Geral: <code>Carla, Geral, carla@x.com, 123</code>
                </p>
                <textarea id="lista-profs-import" rows="6" placeholder="Nome, Turma, Email, Senha"></textarea>
                <button onclick="window.processarImportacaoProfs()">üöÄ Criar Contas</button>
            </div>
            <button onclick="window.fecharAdmin()" class="secondary-btn">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBjtXXfchJQO4vxeI_Vqw1QhV_1CLwB6jc",
            authDomain: "escoladigital-79997.firebaseapp.com",
            projectId: "escoladigital-79997",
            storageBucket: "escoladigital-79997.appspot.com",
            messagingSenderId: "system",
            appId: "system"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ESTRUTURA E VARI√ÅVEIS ---
        let usuarioAtual = null;
        let perfilCoord = null; // Armazena dados originais da coord
        let listaAlunosCache = [];
        const SENHA_EDICAO = "1234";

        const ESTRUTURA_TURMAS = {
            "Ensino Fundamental": [ { nome: "1¬∫ Ano", letras: ["A", "B", "C", "D", "I"] } ],
            "Educa√ß√£o Infantil": [
                { nome: "Ber√ß√°rio", letras: ["A"] },
                { nome: "Infantil 1", letras: ["A", "B", "C", "D", "E", "I"] },
                { nome: "Infantil 2", letras: ["A", "B", "C", "D", "E", "F", "G", "I", "J"] },
                { nome: "Infantil 3", letras: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"] },
                { nome: "Infantil 4", letras: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"] },
                { nome: "Infantil 5", letras: ["A", "B", "C", "D", "E", "F", "G", "I"] }
            ]
        };

        function loading(status) { document.getElementById('loader').style.display = status ? 'flex' : 'none'; }
        function formatarData(d) { if(!d) return ""; return d.split('-').reverse().join('/'); }

        window.onload = function() {
            carregarOpcoesTurma();
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-freq').value = hoje;
            document.getElementById('data-freq').max = hoje;
            document.getElementById('data-plan').value = hoje;
        };

        // --- L√ìGICA DE COORDENA√á√ÉO ---
        
        function verificarNivelAcesso(turmaUsuario) {
            // Se for "Geral", √© Coord Geral
            if (turmaUsuario === "Geral") return "COORD_GERAL";
            
            // Se for o nome de um grupo (Ex: Educa√ß√£o Infantil), √© Coord de N√≠vel
            if (ESTRUTURA_TURMAS[turmaUsuario]) return "COORD_NIVEL";
            
            // Sen√£o, √© Professor
            return "PROFESSOR";
        }

        window.logar = async (user) => {
            const nivel = verificarNivelAcesso(user.turma);
            
            if (nivel === "PROFESSOR") {
                // FLUXO NORMAL DE PROFESSOR
                usuarioAtual = user;
                perfilCoord = null;
                document.getElementById('btn-voltar-coord').style.display = 'none';
                window.abrirPainelTurma(user.turma, user.nome);
            
            } else {
                // FLUXO DE COORDENA√á√ÉO
                usuarioAtual = user; 
                perfilCoord = user; // Salva quem √© a coordenadora
                document.getElementById('display-turma').innerText = "Modo Visualiza√ß√£o";
                window.showView('coord');
                window.renderizarPainelCoord(user.turma, nivel);
            }
        }

        window.renderizarPainelCoord = (filtroTurma, nivel) => {
            const container = document.getElementById('container-turmas');
            container.innerHTML = "";
            document.getElementById('coord-badge').innerText = filtroTurma;

            for (const [grupo, listaSeries] of Object.entries(ESTRUTURA_TURMAS)) {
                // Filtro: Se for Coord N√≠vel, s√≥ mostra o grupo dela. Se for Geral, mostra tudo.
                if (nivel === "COORD_NIVEL" && grupo !== filtroTurma) continue;

                // T√≠tulo do Grupo
                const titulo = document.createElement('div');
                titulo.className = 'grupo-titulo';
                titulo.innerText = grupo;
                container.appendChild(titulo);

                listaSeries.forEach(serie => {
                    serie.letras.forEach(letra => {
                        const nomeTurma = `${serie.nome} ${letra}`;
                        const btn = document.createElement('div');
                        btn.className = 'btn-turma';
                        btn.innerHTML = `<strong>${serie.nome}</strong><span>Turma ${letra}</span>`;
                        btn.onclick = () => window.entrarComoCoord(nomeTurma);
                        container.appendChild(btn);
                    });
                });
            }
        }

        window.entrarComoCoord = async (turmaAlvo) => {
            // "Impersonate": A coord vira professora temporariamente
            usuarioAtual = { nome: perfilCoord.nome + " (Coord)", turma: turmaAlvo };
            
            document.getElementById('btn-voltar-coord').style.display = 'block'; // Mostra bot√£o voltar
            window.abrirPainelTurma(turmaAlvo, usuarioAtual.nome);
        }

        window.voltarParaCoord = () => {
            // Restaura o usu√°rio coord e volta pro painel
            usuarioAtual = perfilCoord;
            window.showView('coord');
        }

        window.abrirPainelTurma = async (turma, nomeUsuario) => {
            document.getElementById('display-turma').innerText = `${turma} | ${nomeUsuario}`;
            window.showView('app');
            await window.carregarAlunosNaTela();
            await window.carregarPlanejamento();
        }

        // --- FUN√á√ïES GERAIS ---

        window.showView = (view) => {
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-cadastro').style.display = 'none';
            document.getElementById('app-painel').style.display = 'none';
            document.getElementById('view-coord').style.display = 'none';

            if(view === 'login') document.getElementById('view-login').style.display = 'flex';
            if(view === 'cadastro') document.getElementById('view-cadastro').style.display = 'flex';
            if(view === 'app') document.getElementById('app-painel').style.display = 'flex';
            if(view === 'coord') document.getElementById('view-coord').style.display = 'block';
        }

        function carregarOpcoesTurma() {
            const select = document.getElementById('cad-turma');
            
            // Op√ß√µes especiais para Coordena√ß√£o
            const grpAdm = document.createElement('optgroup');
            grpAdm.label = "Coordena√ß√£o";
            const optGeral = document.createElement('option');
            optGeral.value = "Geral"; optGeral.innerText = "Coordena√ß√£o Geral (Todas)";
            grpAdm.appendChild(optGeral);
            
            for (const grupo of Object.keys(ESTRUTURA_TURMAS)) {
                const optNivel = document.createElement('option');
                optNivel.value = grupo; optNivel.innerText = `Coord. ${grupo}`;
                grpAdm.appendChild(optNivel);
            }
            select.appendChild(grpAdm);

            // Op√ß√µes de Turmas
            for (const [grupo, listaSeries] of Object.entries(ESTRUTURA_TURMAS)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = grupo;
                listaSeries.forEach(serie => {
                    serie.letras.forEach(letra => {
                        const option = document.createElement('option');
                        option.value = `${serie.nome} ${letra}`;
                        option.innerText = `${serie.nome} ${letra}`;
                        optgroup.appendChild(option);
                    });
                });
                select.appendChild(optgroup);
            }
        }

        // --- SISTEMA ADMIN / SECRETARIA (IMPORTA√á√ÉO) ---
        window.abrirAreaAdmin = () => {
            if(prompt("Senha Mestra:") === "admin") document.getElementById('modal-admin').style.display = 'flex';
            else alert("Senha incorreta.");
        }
        window.fecharAdmin = () => document.getElementById('modal-admin').style.display = 'none';

        window.processarImportacaoProfs = async () => {
            const texto = document.getElementById('lista-profs-import').value;
            if(!texto.trim()) return;
            loading(true);
            const linhas = texto.split('\n');
            const batchPromises = [];
            for (let linha of linhas) {
                const [nome, turma, email, senha] = linha.split(',').map(s => s?.trim());
                if(nome && turma && email && senha) {
                    batchPromises.push(addDoc(collection(db, "professores"), { nome, turma, email, senha }));
                }
            }
            await Promise.all(batchPromises);
            alert("Contas criadas!"); loading(false); window.fecharAdmin();
        }

        // --- L√ìGICA DE DADOS (DB) ---
        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            loading(true);
            try {
                const q = query(collection(db, "professores"), where("email", "==", email), where("senha", "==", senha));
                const snap = await getDocs(q);
                if(snap.empty) alert("Dados incorretos.");
                else window.logar(snap.docs[0].data());
            } catch(e) { alert("Erro conex√£o."); } finally { loading(false); }
        }

        window.fazerCadastro = async () => {
            const nome = document.getElementById('cad-nome').value;
            const turma = document.getElementById('cad-turma').value;
            const email = document.getElementById('cad-email').value;
            const senha = document.getElementById('cad-senha').value;
            if(!nome || !turma || !email || !senha) return alert("Preencha tudo!");
            loading(true);
            try {
                await addDoc(collection(db, "professores"), { nome, turma, email, senha });
                alert("Cadastrado!"); window.logar({ nome, turma, email, senha });
            } catch(e) { alert("Erro."); } finally { loading(false); }
        }
        
        window.fazerLogout = () => { usuarioAtual = null; perfilCoord = null; window.showView('login'); }
        window.mudarAba = (aba) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            document.getElementById('btn-tab-' + aba).classList.add('active');
        }

        window.verificarChamadaDia = async () => {
            const dt = document.getElementById('data-freq').value;
            document.querySelectorAll('.status-btn').forEach(b => { b.className = 'status-btn presente'; b.innerText = 'Presente'; });
            try {
                const snap = await getDocs(query(collection(db, "frequencia"), where("turma", "==", usuarioAtual.turma), where("data", "==", dt)));
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    document.querySelectorAll('#lista-tbody tr').forEach(row => {
                        const nome = row.cells[0].innerText;
                        const info = d.detalhes.find(x => x.nome === nome);
                        if(info) {
                            const btn = row.cells[1].querySelector('button');
                            btn.className = info.presente ? 'status-btn presente' : 'status-btn ausente';
                            btn.innerText = info.presente ? 'Presente' : 'Ausente';
                        }
                    });
                }
            } catch(e) {}
        }

        window.carregarAlunosNaTela = async () => {
            loading(true);
            const tbody = document.getElementById('lista-tbody'); tbody.innerHTML = "";
            try {
                const snap = await getDocs(query(collection(db, "alunos"), where("turma", "==", usuarioAtual.turma)));
                listaAlunosCache = [];
                snap.forEach(d => listaAlunosCache.push({ id: d.id, ...d.data() }));
                listaAlunosCache.sort((a,b) => a.nome.localeCompare(b.nome));
                document.getElementById('msg-vazia').style.display = listaAlunosCache.length ? 'none' : 'block';
                listaAlunosCache.forEach(aluno => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${aluno.nome}</td><td style="text-align:center;"><button class="status-btn presente" onclick="window.toggleStatus(this)">Presente</button></td><td class="no-print" style="text-align:center;"><button style="border:none;background:none;cursor:pointer;" onclick="window.removerAluno('${aluno.id}')">üóëÔ∏è</button></td>`;
                    tbody.appendChild(tr);
                });
                await window.verificarChamadaDia();
            } catch(e) {} finally { loading(false); }
        }

        window.toggleStatus = (btn) => {
            if(btn.classList.contains('presente')) { btn.className = 'status-btn ausente'; btn.innerText = "Ausente"; }
            else { btn.className = 'status-btn presente'; btn.innerText = "Presente"; }
        }
        
        window.salvarChamada = async () => {
            const data = document.getElementById('data-freq').value;
            const linhas = document.querySelectorAll('#lista-tbody tr');
            if(!linhas.length) return alert("Sem alunos.");
            loading(true);
            const detalhes = []; let presentes = 0;
            linhas.forEach(tr => {
                const nome = tr.cells[0].innerText;
                const p = tr.cells[1].querySelector('button').classList.contains('presente');
                if(p) presentes++; detalhes.push({ nome, presente: p });
            });
            try {
                await setDoc(doc(db, "frequencia", usuarioAtual.turma.replace(/\s/g,'')+"_"+data), { data, turma: usuarioAtual.turma, detalhes, resumo: `${presentes} Presentes / ${linhas.length-presentes} Ausentes` });
                alert("Salvo!");
            } catch(e) { alert("Erro."); } finally { loading(false); }
        }

        window.carregarPlanejamento = async () => {
            const dt = document.getElementById('data-plan').value;
            window.limparTelaPlanejamento(false);
            toggleCamposEdicao(true); document.getElementById('btn-editar-plan').style.display = 'none';
            try {
                const snap = await getDocs(query(collection(db, "planejamentos"), where("turma", "==", usuarioAtual.turma), where("data", "==", dt)));
                if(!snap.empty) {
                    const s = snap.docs[0].data();
                    document.getElementById('plan-disciplina').value = s.disciplina||""; document.getElementById('plan-tema').value = s.tema||"";
                    document.getElementById('plan-objetivos').value = s.objetivos||""; document.getElementById('plan-metodologia').value = s.metodologia||"";
                    document.getElementById('plan-avaliacao').value = s.avaliacao||"";
                    toggleCamposEdicao(false); document.getElementById('btn-editar-plan').style.display = 'inline-block';
                }
            } catch(e) {}
        }

        function toggleCamposEdicao(ativo) { document.querySelectorAll('.input-plan').forEach(el => el.disabled = !ativo); }
        window.desbloquearEdicao = () => { if(prompt("Senha edi√ß√£o:") === SENHA_EDICAO) { toggleCamposEdicao(true); document.getElementById('btn-editar-plan').style.display = 'none'; } else alert("Senha incorreta"); }
        
        window.salvarPlanejamento = async () => {
            const data = document.getElementById('data-plan').value;
            const plano = {
                data, turma: usuarioAtual.turma,
                disciplina: document.getElementById('plan-disciplina').value, tema: document.getElementById('plan-tema').value,
                objetivos: document.getElementById('plan-objetivos').value, metodologia: document.getElementById('plan-metodologia').value,
                avaliacao: document.getElementById('plan-avaliacao').value
            };
            loading(true);
            try { await setDoc(doc(db, "planejamentos", usuarioAtual.turma.replace(/\s/g,'')+"_"+data), plano); alert("Salvo!"); toggleCamposEdicao(false); document.getElementById('btn-editar-plan').style.display='inline-block'; } 
            catch(e) { alert("Erro."); } finally { loading(false); }
        }

        window.limparTelaPlanejamento = (c=true) => { if(!c || confirm("Limpar?")) { document.querySelectorAll('.input-plan').forEach(e=>e.value=""); if(c) { toggleCamposEdicao(true); document.getElementById('btn-editar-plan').style.display='none'; } } }
        
        window.abrirHistorico = async (tipo) => {
            const m = document.getElementById('modal-historico'); const l = document.getElementById('modal-lista');
            l.innerHTML = "Carregando..."; m.style.display = 'flex';
            try {
                const snap = await getDocs(query(collection(db, tipo==='freq'?"frequencia":"planejamentos"), where("turma", "==", usuarioAtual.turma)));
                const i = []; snap.forEach(d=>i.push(d.data())); i.sort((a,b)=>new Date(b.data)-new Date(a.data));
                l.innerHTML = i.length ? "" : "Nenhum registro.";
                i.forEach(item => {
                    const d = document.createElement('div'); d.className='hist-item';
                    d.innerHTML = `<span>${formatarData(item.data)}</span><span>${tipo==='freq'?item.resumo:(item.tema||'Sem tema')}</span><button onclick="window.carregarDataHistorico('${item.data}','${tipo}')" style="width:auto;padding:5px 10px;">Abrir</button>`;
                    l.appendChild(d);
                });
            } catch(e) {}
        }
        window.carregarDataHistorico = (d,t) => { window.fecharHistorico(); document.getElementById(t==='freq'?'data-freq':'data-plan').value=d; t==='freq'?window.verificarChamadaDia():window.carregarPlanejamento(); }
        window.fecharHistorico = () => document.getElementById('modal-historico').style.display = 'none';

        window.toggleImport = () => { const a = document.getElementById('area-importacao'); a.style.display = a.style.display==='none'?'block':'none'; }
        window.processarImportacao = async () => {
            const t = document.getElementById('lista-import').value; if(!t.trim()) return;
            loading(true);
            const ps = []; t.split('\n').forEach(l => { const p=l.split(','); if(p.length>=2) ps.push(addDoc(collection(db, "alunos"), {nome:p[0].trim(), turma:p[1].trim()})); });
            await Promise.all(ps); alert("Importado!"); loading(false); window.carregarAlunosNaTela();
        }
        window.removerAluno = async (id) => { if(confirm("Remover?")) { await deleteDoc(doc(db, "alunos", id)); window.carregarAlunosNaTela(); } }

    </script>
</body>
</html>
