<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa de Criança - Agendamento</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandAzul: '#003366', 
                        brandVerde: '#00A8A8',
                    }
                }
            }
        }
    </script>

    <style>
        @media print {
            body * { visibility: hidden; }
            #area-impressao, #area-impressao * { visibility: visible; }
            #area-impressao { position: absolute; left: 0; top: 0; width: 100%; }
            @page { margin: 1.5cm; }
        }
        .data-ativa { background-color: #00A8A8 !important; color: white !important; border-color: #00A8A8 !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <header class="bg-white text-brandAzul shadow-md sticky top-0 z-50 print:hidden border-b-4 border-brandVerde">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://drive.google.com/thumbnail?id=1rl8NUZkkDBhw-U5KjGBxUu2UwaPLNJVO&sz=w500" alt="Logo" class="h-14 w-auto object-contain">
            </div>

            <div class="flex items-center gap-2">
                <button id="btn-login-prof" onclick="acessoProfessor()" class="text-xs md:text-sm bg-slate-100 hover:bg-slate-200 border border-slate-300 px-4 py-2 rounded-lg text-brandAzul font-bold transition flex items-center gap-2">
                    <i class="fas fa-lock"></i> <span>Área Restrita</span>
                </button>
                <button id="btn-sair-admin" onclick="location.reload()" class="hidden text-sm bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-white font-bold transition">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto mt-8 p-4 mb-20 max-w-6xl print:hidden">
        
        <section id="view-pais" class="block animate-fade-in">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200 text-center mb-8">
                <h2 class="text-2xl font-bold text-brandAzul mb-6">Agendamento de Reuniões</h2>
                
                <div class="relative max-w-md mx-auto mb-10">
                    <select id="filtro-turma-pais" onchange="selecionarTurma()" class="w-full p-4 pl-12 text-lg border-2 border-slate-200 rounded-xl focus:border-brandVerde outline-none bg-white cursor-pointer appearance-none">
                        <option value="" disabled selected>Escolha sua turma...</option>
                    </select>
                    <i class="fas fa-graduation-cap absolute left-4 top-5 text-brandVerde text-xl pointer-events-none"></i>
                </div>

                <div id="area-datas" class="hidden text-left max-w-4xl mx-auto">
                    <h3 class="text-sm font-bold text-brandAzul uppercase mb-4 border-b pb-2">1. Selecione a Data</h3>
                    <div id="lista-datas" class="flex flex-wrap gap-3 justify-center md:justify-start mb-10"></div>
                </div>

                <div id="area-horarios" class="hidden text-left max-w-4xl mx-auto border-t border-slate-100 pt-8">
                    <h3 class="text-sm font-bold text-brandAzul uppercase mb-4">2. Selecione o Horário</h3>
                    <div id="grid-horarios" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </div>

                <div id="msg-vazia" class="hidden text-center text-slate-400 py-12">Nenhum horário disponível para esta turma.</div>
            </div>
        </section>

        <section id="view-admin" class="hidden space-y-8">
            <div class="bg-brandAzul text-white p-6 rounded-2xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex-1">
                    <h3 class="font-bold text-xl mb-4">Gestão de Agendamentos</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="compartilharZap()" class="bg-green-500 hover:bg-green-600 px-5 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button onclick="copiarLink()" class="bg-white/10 hover:bg-white/20 px-5 py-2 rounded-lg text-sm font-bold border border-white/30">
                            <i class="fas fa-copy"></i> Copiar Link
                        </button>
                        <button onclick="imprimirRelatorio()" class="bg-brandVerde hover:bg-brandVerde/80 px-5 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2">
                            <i class="fas fa-print"></i> Imprimir Lista
                        </button>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-xl"><div id="qrcode"></div></div>
            </div>

            <div class="bg-white border-t-4 border-brandAzul p-6 rounded-2xl shadow-md">
                <h3 class="text-xl font-bold text-brandAzul mb-6">Gerar Novos Horários</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">TURMA</label>
                        <select id="gen-turma" class="w-full border p-2.5 rounded-lg outline-none bg-slate-50 focus:ring-2 focus:ring-brandVerde">
                            <option value="" disabled selected>Selecione...</option>
                            <optgroup label="Infantil 1"><option value="Infantil 1A">Infantil 1A</option><option value="Infantil 1B">Infantil 1B</option><option value="Infantil 1C">Infantil 1C</option><option value="Infantil 1D">Infantil 1D</option><option value="Infantil 1E">Infantil 1E</option><option value="Infantil 1F">Infantil 1F</option><option value="Infantil 1G">Infantil 1G</option></optgroup>
                            <optgroup label="Infantil 2"><option value="Infantil 2A">Infantil 2A</option><option value="Infantil 2B">Infantil 2B</option><option value="Infantil 2C">Infantil 2C</option><option value="Infantil 2D">Infantil 2D</option><option value="Infantil 2E">Infantil 2E</option><option value="Infantil 2F">Infantil 2F</option><option value="Infantil 2G">Infantil 2G</option><option value="Infantil 2I">Infantil 2I</option><option value="Infantil 2J">Infantil 2J</option></optgroup>
                            <optgroup label="Infantil 3"><option value="Infantil 3A">Infantil 3A</option><option value="Infantil 3B">Infantil 3B</option><option value="Infantil 3C">Infantil 3C</option><option value="Infantil 3D">Infantil 3D</option><option value="Infantil 3E">Infantil 3E</option><option value="Infantil 3F">Infantil 3F</option><option value="Infantil 3G">Infantil 3G</option><option value="Infantil 3H">Infantil 3H</option><option value="Infantil 3I">Infantil 3I</option><option value="Infantil 3J">Infantil 3J</option></optgroup>
                            <optgroup label="Infantil 4"><option value="Infantil 4A">Infantil 4A</option><option value="Infantil 4B">Infantil 4B</option><option value="Infantil 4C">Infantil 4C</option><option value="Infantil 4D">Infantil 4D</option><option value="Infantil 4E">Infantil 4E</option><option value="Infantil 4F">Infantil 4F</option><option value="Infantil 4I">Infantil 4I</option><option value="Infantil 4J">Infantil 4J</option></optgroup>
                            <optgroup label="Infantil 5"><option value="Infantil 5A">Infantil 5A</option><option value="Infantil 5B">Infantil 5B</option><option value="Infantil 5C">Infantil 5C</option><option value="Infantil 5D">Infantil 5D</option><option value="Infantil 5E">Infantil 5E</option><option value="Infantil 5F">Infantil 5F</option><option value="Infantil 5G">Infantil 5G</option><option value="Infantil 5I">Infantil 5I</option></optgroup>
                            <optgroup label="1 Ano"><option value="1 Ano A">1 Ano A</option><option value="1 Ano B">1 Ano B</option><option value="1 Ano C">1 Ano C</option><option value="1 Ano D">1 Ano D</option><option value="1 Ano I">1 Ano I</option></optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">DATA</label>
                        <input type="date" id="gen-data" class="w-full border p-2.5 rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">INÍCIO</label>
                        <input type="time" id="gen-inicio" value="08:00" class="w-full border p-2.5 rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">FIM</label>
                        <input type="time" id="gen-fim" value="11:40" class="w-full border p-2.5 rounded-lg bg-slate-50">
                    </div>
                    <div><button onclick="gerarAutomatico()" class="w-full bg-brandVerde hover:bg-brandVerde/90 text-white font-bold py-2.5 rounded-lg shadow-md transition">Gerar</button></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-brandAzul text-sm">Controle Geral</h3>
                    <button onclick="limparTudo()" class="text-red-500 text-[10px] font-bold uppercase border border-red-200 px-2 py-1 rounded">Limpar Todos os Dados</button>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-600 sticky top-0">
                            <tr>
                                <th class="p-4">Turma</th>
                                <th class="p-4">Data/Hora</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Pai / Aluno</th>
                                <th class="p-4">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-admin" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="area-impressao" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDBWADP0CJMbIg5dlU_F4U-LSUbZ_KGngo",
            authDomain: "agendacdc-7c58a.firebaseapp.com",
            projectId: "agendacdc-7c58a",
            storageBucket: "agendacdc-7c58a.firebasestorage.app",
            messagingSenderId: "695482072180",
            appId: "1:695482072180:web:574479422e33dcfd3b6521"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "agendamentos");
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkCfZOtgj54l47hwmyzcvqP8muTX8dtojcOS4MQ3N1ZKqmbEhJKR7BdYPdajQVNLiVvQ/exec";

        // TODOS OS E-MAILS DO SEU ARQUIVO ORIGINAL RESTAURADOS
        const EMAILS_PROFESSORES = {
            "Infantil 1A": "gabrielsimao@casadecrianca.com.br",
            "Infantil 1B": "email@escola.com",
            "Infantil 1C": "joaopaiva@casadecrianca.com.br",
            "Infantil 2A": "girlanemelo@casadecriancaec.com.br",
            "Infantil 2B": "vildeniabalreira@casadecriancaec.com.br",
            "Infantil 2C": "gracamagalhaes@casadecriancaec.com.br",
            "Infantil 2D": "kilviabatista@casadecriancaec.com.br",
            "Infantil 2E": "brenaoliveira@casadecriancaec.com.br",
            "Infantil 2F": "marialuiza@casadecriancaec.com.br",
            "Infantil 2G": "anaveronicaqueiroz@casadecriancaec.com.br",
            "Infantil 2I": "joanacarlos@casadecriancaec.com.br",
            "Infantil 2J": "kilviabatista@casadecriancaec.com.br",
            "Infantil 3A": "camilareis@casadecriancaec.com.br",
            "Infantil 3B": "gabrielakatriny@casadecriancaec.com.br",
            "Infantil 3C": "mikaelybezerra@casadecriancaec.com.br",
            "Infantil 3D": "camilaquirino@casadecriancaec.com.br",
            "Infantil 3E": "fabianesantiago@casadecriancaec.com.br",
            "Infantil 3F": "brunaferreira@casadecriancaec.com.br",
            "Infantil 3G": "anapaula@casadecriancaec.com.br",
            "Infantil 3H": "alinebranco@casadecriancaec.com.br",
            "Infantil 3I": "luizafreitas@casadecriancaec.com.br",
            "Infantil 4A": "margotmodesto@casadecriancaec.com.br",
            "Infantil 4B": "joycevalente@casadecriancaec.com.br",
            "Infantil 4C": "rogenyaandrade@casadecriancaec.com.br",
            "Infantil 4D": "anabrandao@casadecriancaec.com.br",
            "Infantil 4E": "willianesilva@casadecriancaec.com.br",
            "Infantil 4F": "raquelsanders@casadecriancaec.com.br",
            "Infantil 5A": "midiamendes@casadecriancaec.com.br",
            "Infantil 5B": "leticyaribeiro@casadecriancaec.com.br",
            "Infantil 5C": "daniellesouza@casadecriancaec.com.br",
            "1 Ano A": "rosangelasaraiva@casadecriancaec.com.br",
            "1 Ano B": "thaissantana@casadecriancaec.com.br",
            "PADRAO": "Tecnologia@casadecrianca.com.br"
        };

        let todosDados = [];
        let isAdmin = false;

        window.acessoProfessor = async () => {
            const { value: senha } = await Swal.fire({ title: 'Acesso Administrativo', input: 'password', confirmButtonColor: '#00A8A8' });
            if (senha === '1992') {
                isAdmin = true;
                document.getElementById('view-pais').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
                document.getElementById('btn-sair-admin').classList.remove('hidden');
                document.getElementById('btn-login-prof').classList.add('hidden');
                gerarQRCode();
                renderAdminTable();
            }
        };

        onSnapshot(query(colRef, orderBy("timestamp", "asc")), (snapshot) => {
            todosDados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            atualizarDropdownTurmas();
            if(isAdmin) renderAdminTable();
        });

        function atualizarDropdownTurmas() {
            const turmas = [...new Set(todosDados.map(i => i.turma))].sort();
            const sel = document.getElementById('filtro-turma-pais');
            sel.innerHTML = '<option value="" disabled selected>Escolha sua turma...</option>' + 
                             turmas.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        window.selecionarTurma = () => {
            const turma = document.getElementById('filtro-turma-pais').value;
            const disponiveis = todosDados.filter(i => i.turma === turma && i.disponivel);
            const area = document.getElementById('area-datas');
            
            if(disponiveis.length === 0) { area.classList.add('hidden'); document.getElementById('msg-vazia').classList.remove('hidden'); return; }
            
            document.getElementById('msg-vazia').classList.add('hidden');
            area.classList.remove('hidden');
            const datas = [...new Set(disponiveis.map(i => i.data))].sort();
            document.getElementById('lista-datas').innerHTML = datas.map(d => `
                <button onclick="carregarHorarios('${turma}', '${d}')" class="px-6 py-4 bg-white border-2 border-slate-200 rounded-2xl font-bold text-brandAzul hover:border-brandVerde transition">
                    ${d.split('-').reverse().slice(0,2).join('/')}
                </button>
            `).join('');
        };

        window.carregarHorarios = (turma, data) => {
            document.getElementById('area-horarios').classList.remove('hidden');
            document.getElementById('grid-horarios').innerHTML = todosDados
                .filter(i => i.turma === turma && i.data === data && i.disponivel)
                .map(item => `
                    <button onclick="reservar('${item.id}', '${item.horario}', '${item.data}', '${item.turma}')" 
                        class="bg-cyan-50 hover:bg-brandVerde hover:text-white text-brandVerde font-bold py-4 rounded-xl border border-cyan-100 transition">
                        ${item.horario}
                    </button>`).join('');
        };

        window.reservar = async (id, hora, dataIso, turma) => {
            const { value: form } = await Swal.fire({
                title: 'Agendar Horário',
                html: `<input id="swal-resp" class="swal2-input" placeholder="Seu Nome"><input id="swal-aluno" class="swal2-input" placeholder="Nome do Aluno"><input id="swal-email" class="swal2-input" placeholder="Seu E-mail">`,
                preConfirm: () => ({ r: document.getElementById('swal-resp').value, a: document.getElementById('swal-aluno').value, e: document.getElementById('swal-email').value })
            });

            if (form && form.r && form.a && form.e) {
                Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
                await updateDoc(doc(db, "agendamentos", id), { disponivel: false, pai: `${form.r} (Aluno: ${form.a})` });
                
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST", mode: "no-cors",
                    body: JSON.stringify({
                        nomeResponsavel: form.r, nomeAluno: form.a, turma: turma,
                        emailProfessor: EMAILS_PROFESSORES[turma] || EMAILS_PROFESSORES["PADRAO"],
                        emailResponsavel: form.e, data: dataIso.split('-').reverse().join('/'), horario: hora
                    })
                });
                Swal.fire('Sucesso!', 'Seu horário foi reservado.', 'success');
            }
        };

        window.gerarAutomatico = async () => {
            const t = document.getElementById('gen-turma').value;
            const d = document.getElementById('gen-data').value;
            const batch = writeBatch(db);
            let atual = new Date(`2000-01-01T${document.getElementById('gen-inicio').value}`);
            let limite = new Date(`2000-01-01T${document.getElementById('gen-fim').value}`);

            while (atual < limite) {
                const h = atual.toTimeString().substring(0, 5);
                batch.set(doc(collection(db, "agendamentos")), { turma: t, data: d, horario: h, disponivel: true, pai: "", timestamp: new Date(`${d}T${h}`).getTime() });
                atual.setMinutes(atual.getMinutes() + 20);
            }
            await batch.commit();
            Swal.fire('Gerado!', 'Horários criados com sucesso.', 'success');
        };

        window.renderAdminTable = () => {
            document.getElementById('tabela-admin').innerHTML = todosDados.map(item => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-bold text-brandAzul">${item.turma}</td>
                    <td class="p-4">${item.data.split('-').reverse().join('/')} às ${item.horario}</td>
                    <td class="p-4"><span class="${item.disponivel ? 'text-green-600' : 'text-red-600'} font-bold">${item.disponivel ? 'Livre' : 'Ocupado'}</span></td>
                    <td class="p-4 text-xs">${item.pai || '—'}</td>
                    <td class="p-4"><button onclick="deletar('${item.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        };

        window.deletar = async (id) => { if(confirm('Excluir horário?')) await deleteDoc(doc(db, "agendamentos", id)); };

        window.limparTudo = async () => {
            const { value: confirm } = await Swal.fire({ title: 'Atenção!', text: "Digite 'DELETAR' para apagar tudo", input: 'text' });
            if (confirm === 'DELETAR') {
                const snap = await getDocs(colRef);
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                Swal.fire('Limpo!');
            }
        };

        window.imprimirRelatorio = () => {
            const area = document.getElementById('area-impressao');
            let html = `<div style="padding:40px">
                <h2 style="text-align:center; color:#003366">Lista de Agendamentos</h2>
                <table style="width:100%; border-collapse:collapse; margin-top:20px">
                    <thead style="border-bottom:2px solid #003366"><tr><th>Turma</th><th>Data</th><th>Hora</th><th>Responsável</th></tr></thead>
                    <tbody>`;
            todosDados.filter(i => !i.disponivel).forEach(item => {
                html += `<tr style="border-bottom:1px solid #eee"><td style="padding:10px">${item.turma}</td><td>${item.data.split('-').reverse().join('/')}</td><td>${item.horario}</td><td>${item.pai}</td></tr>`;
            });
            html += '</tbody></table></div>';
            area.innerHTML = html;
            window.print();
        };

        function gerarQRCode() { new QRCode(document.getElementById("qrcode"), { text: window.location.href.split('?')[0], width: 80, height: 80 }); }
        window.copiarLink = () => { navigator.clipboard.writeText(window.location.href.split('?')[0]); alert('Link copiado!'); };
        window.compartilharZap = () => { window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(window.location.href.split('?')[0])}`, '_blank'); };
    </script>
</body>
</html>
