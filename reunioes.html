<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa de Criança - Agendamento</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandAzul: '#003366', 
                        brandVerde: '#00A8A8',
                    }
                }
            }
        }
    </script>

    <style>
        @media print {
            body * { visibility: hidden; }
            #area-impressao, #area-impressao * { visibility: visible; }
            #area-impressao { position: absolute; left: 0; top: 0; width: 100%; }
            @page { margin: 1cm; }
        }
        .data-ativa { background-color: #00A8A8 !important; color: white !important; border-color: #00A8A8 !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <header class="bg-white text-brandAzul shadow-md sticky top-0 z-50 print:hidden border-b-4 border-brandVerde">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center relative">
            <div id="logo-container" class="flex items-center gap-3 select-none">
                <img src="https://drive.google.com/thumbnail?id=1rl8NUZkkDBhw-U5KjGBxUu2UwaPLNJVO&sz=w500" alt="Logo Casa de Criança" class="h-14 w-auto object-contain">
            </div>

            <div class="flex items-center gap-2">
                <button id="btn-login-prof" onclick="acessoProfessor()" class="text-xs md:text-sm bg-slate-100 hover:bg-slate-200 border border-slate-300 px-4 py-2 rounded-lg text-brandAzul font-bold transition flex items-center gap-2">
                    <i class="fas fa-lock"></i> 
                    <span class="hidden md:inline">Área Restrita</span>
                </button>

                <button id="btn-sair-admin" onclick="sairAdmin()" class="hidden text-sm bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-white font-bold transition flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto mt-8 p-4 mb-20 max-w-6xl print:hidden">
        
        <section id="view-pais" class="block animate-fade-in">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200 text-center mb-8">
                <div class="inline-block p-4 rounded-full bg-cyan-50 text-brandVerde mb-4">
                    <i class="fas fa-calendar-alt text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-brandAzul mb-2">Agendamento de Reuniões</h2>
                <p class="text-slate-500 mb-8">Selecione a turma para visualizar as datas disponíveis.</p>
                
                <div class="relative max-w-md mx-auto mb-10">
                    <select id="filtro-turma-pais" onchange="selecionarTurma()" class="w-full p-4 pl-12 text-lg border-2 border-slate-200 rounded-xl focus:border-brandVerde outline-none bg-white cursor-pointer hover:border-brandVerde/50 transition shadow-sm appearance-none">
                        <option value="" disabled selected>Carregando turmas...</option>
                    </select>
                    <i class="fas fa-graduation-cap absolute left-4 top-5 text-brandVerde text-xl pointer-events-none"></i>
                    <i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i>
                </div>

                <div id="area-datas" class="hidden text-left max-w-4xl mx-auto">
                    <h3 class="text-sm font-bold text-brandAzul uppercase tracking-wider mb-4 border-b pb-2">1. Escolha uma Data</h3>
                    <div id="lista-datas" class="flex flex-wrap gap-3 justify-center md:justify-start mb-10"></div>
                </div>

                <div id="area-horarios" class="hidden text-left max-w-4xl mx-auto border-t border-slate-100 pt-8 fade-in">
                    <h3 class="text-sm font-bold text-brandAzul uppercase tracking-wider mb-4">2. Escolha um Horário</h3>
                    <div id="grid-horarios" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                </div>

                <div id="msg-vazia" class="hidden text-center text-slate-500 py-12 bg-slate-50 rounded-xl border border-dashed border-slate-300 mt-6">
                    <i class="fas fa-calendar-times text-4xl text-slate-300 mb-3 block"></i>
                    Nenhuma agenda aberta para esta turma no momento.
                </div>
            </div>
        </section>

        <section id="view-admin" class="hidden space-y-8">
            <div class="bg-brandAzul text-white p-6 rounded-2xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex-1 text-center md:text-left">
                    <h3 class="font-bold text-xl flex items-center justify-center md:justify-start gap-2">
                        <i class="fas fa-link text-brandVerde"></i> Painel de Gestão
                    </h3>
                    <p class="text-blue-100 text-sm mt-2 mb-4">Gerencie os horários e compartilhe o acesso.</p>
                    <div class="flex flex-wrap justify-center md:justify-start gap-2">
                        <button onclick="compartilharZap()" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button onclick="copiarLink()" class="bg-white/10 hover:bg-white/20 text-white border border-white/30 px-5 py-2 rounded-lg text-sm font-bold transition">
                            <i class="fas fa-copy"></i> Copiar Link
                        </button>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-inner">
                    <div id="qrcode"></div>
                </div>
            </div>

            <div class="bg-purple-50 border border-purple-200 p-6 rounded-2xl shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="font-bold text-purple-900 text-lg"><i class="fas fa-print mr-2"></i>Centro de Impressão</h3>
                    <p class="text-purple-700 text-sm">Gere o PDF com a lista de agendados.</p>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <select id="select-impressao" class="border border-purple-300 rounded-lg p-2 text-sm outline-none"></select>
                    <button onclick="imprimirRelatorio()" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Imprimir
                    </button>
                </div>
            </div>

            <div class="bg-white border-t-4 border-brandAzul p-6 rounded-2xl shadow-md">
                <h3 class="text-xl font-bold text-brandAzul mb-6"><i class="fas fa-plus-circle mr-2 text-brandVerde"></i>Criar Novos Horários</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">TURMA</label>
                        <select id="gen-turma" class="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-brandVerde outline-none bg-slate-50">
                            <option value="" disabled selected>Selecione...</option>
                            <optgroup label="Infantil"><option value="Infantil 1A">Infantil 1A</option><option value="Infantil 1B">Infantil 1B</option><option value="Infantil 2A">Infantil 2A</option><option value="Infantil 3A">Infantil 3A</option></optgroup>
                            <optgroup label="Fundamental"><option value="1 Ano A">1 Ano A</option><option value="1 Ano B">1 Ano B</option></optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">DATA</label>
                        <input type="date" id="gen-data" class="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-brandVerde outline-none bg-slate-50">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1 text-center">INTERVALO (INÍCIO - FIM)</label>
                        <div class="flex items-center gap-2">
                            <input type="time" id="gen-inicio" value="08:00" class="w-full border p-2.5 rounded-lg text-center bg-slate-50">
                            <span class="text-slate-400">até</span>
                            <input type="time" id="gen-fim" value="11:40" class="w-full border p-2.5 rounded-lg text-center bg-slate-50">
                        </div>
                    </div>
                    <div>
                        <button onclick="gerarAutomatico()" class="w-full bg-brandVerde hover:bg-brandVerde/90 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition">Gerar Horários</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-brandAzul text-sm">Controle de Agendamentos</h3>
                    <button onclick="limparTudo()" class="text-red-500 text-[10px] font-bold hover:bg-red-50 px-3 py-1.5 rounded-lg border border-red-200 uppercase">Zerar Tudo</button>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th class="p-4">Turma</th>
                                <th class="p-4">Data/Hora</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Responsável / Aluno</th>
                                <th class="p-4 text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-admin" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="area-impressao" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDBWADP0CJMbIg5dlU_F4U-LSUbZ_KGngo",
            authDomain: "agendacdc-7c58a.firebaseapp.com",
            projectId: "agendacdc-7c58a",
            storageBucket: "agendacdc-7c58a.firebasestorage.app",
            messagingSenderId: "695482072180",
            appId: "1:695482072180:web:574479422e33dcfd3b6521"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "agendamentos");
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkCfZOtgj54l47hwmyzcvqP8muTX8dtojcOS4MQ3N1ZKqmbEhJKR7BdYPdajQVNLiVvQ/exec";

        const EMAILS_PROFESSORES = {
            "Infantil 1A": "gabrielsimao@casadecrianca.com.br",
            "Infantil 1B": "email@escola.com",
            "Infantil 1C": "joaopaiva@casadecrianca.com.br",
            "Infantil 2A": "girlanemelo@casadecriancaec.com.br",
            "PADRAO": "Tecnologia@casadecrianca.com.br"
        };

        let todosDados = [];
        let isAdmin = false;

        window.acessoProfessor = async () => {
            const { value: senha } = await Swal.fire({
                title: 'Acesso Administrativo',
                input: 'password',
                inputPlaceholder: 'Digite a senha',
                showCancelButton: true,
                confirmButtonColor: '#00A8A8'
            });
            if (senha === '1992') {
                isAdmin = true;
                document.getElementById('view-pais').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
                document.getElementById('btn-sair-admin').classList.remove('hidden');
                document.getElementById('btn-login-prof').classList.add('hidden');
                renderAdminTable();
                gerarQRCode();
                
                // Popula select de impressão
                const tUnicas = [...new Set(todosDados.map(i => i.turma))].sort();
                const sel = document.getElementById('select-impressao');
                sel.innerHTML = '<option value="">Todas as turmas</option>' + tUnicas.map(t => `<option value="${t}">${t}</option>`).join('');
            } else if (senha) {
                Swal.fire('Erro', 'Senha incorreta.', 'error');
            }
        };

        window.sairAdmin = () => location.reload();

        const q = query(colRef, orderBy("timestamp", "asc"));
        onSnapshot(q, (snapshot) => {
            todosDados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            atualizarDropdownTurmas();
            if(isAdmin) renderAdminTable();
        });

        function atualizarDropdownTurmas() {
            const turmasUnicas = [...new Set(todosDados.map(item => item.turma))].sort();
            const select = document.getElementById('filtro-turma-pais');
            let html = '<option value="" disabled selected>Escolha sua turma...</option>';
            turmasUnicas.forEach(t => html += `<option value="${t}">${t}</option>`);
            select.innerHTML = html;
        }

        window.selecionarTurma = () => {
            const turma = document.getElementById('filtro-turma-pais').value;
            const horarios = todosDados.filter(i => i.turma === turma && i.disponivel);
            const areaDatas = document.getElementById('area-datas');
            const listaDatas = document.getElementById('lista-datas');
            const msg = document.getElementById('msg-vazia');

            if(horarios.length === 0) {
                areaDatas.classList.add('hidden');
                msg.classList.remove('hidden');
                return;
            }

            msg.classList.add('hidden');
            areaDatas.classList.remove('hidden');
            const datasUnicas = [...new Set(horarios.map(i => i.data))].sort();
            listaDatas.innerHTML = "";
            
            datasUnicas.forEach(dataIso => {
                const btn = document.createElement('button');
                btn.className = "px-6 py-4 bg-white border-2 border-slate-200 rounded-2xl font-bold text-brandAzul hover:border-brandVerde hover:text-brandVerde transition flex flex-col items-center min-w-[120px]";
                btn.innerHTML = `<span class="text-xl">${dataIso.split('-').reverse().slice(0,2).join('/')}</span><span class="text-[10px] text-slate-400 font-normal">Disponível</span>`;
                btn.onclick = () => {
                    document.querySelectorAll('#lista-datas button').forEach(b => b.classList.remove('data-ativa'));
                    btn.classList.add('data-ativa');
                    carregarHorarios(turma, dataIso);
                };
                listaDatas.appendChild(btn);
            });
        };

        function carregarHorarios(turma, data) {
            const grid = document.getElementById('grid-horarios');
            document.getElementById('area-horarios').classList.remove('hidden');
            grid.innerHTML = "";

            todosDados.filter(i => i.turma === turma && i.data === data && i.disponivel).forEach(item => {
                grid.innerHTML += `
                    <button onclick="reservar('${item.id}', '${item.horario}', '${item.data}', '${item.turma}')" 
                        class="bg-cyan-50 hover:bg-brandVerde hover:text-white text-brandVerde font-bold py-4 px-2 rounded-xl border border-cyan-100 transition shadow-sm">
                        ${item.horario}
                    </button>`;
            });
        }

        window.reservar = async (id, hora, dataIso, turma) => {
            const dataBr = dataIso.split('-').reverse().join('/');
            const { value: formValues } = await Swal.fire({
                title: 'Confirmar Agendamento',
                html: `
                    <div class="text-left space-y-3 p-2">
                        <input id="swal-resp" class="w-full p-2 border rounded" placeholder="Nome do Responsável">
                        <input id="swal-aluno" class="w-full p-2 border rounded" placeholder="Nome do Aluno">
                        <input id="swal-email" type="email" class="w-full p-2 border rounded" placeholder="E-mail para confirmação">
                    </div>`,
                preConfirm: () => {
                    const r = document.getElementById('swal-resp').value;
                    const a = document.getElementById('swal-aluno').value;
                    const e = document.getElementById('swal-email').value;
                    if (!r || !a || !e) Swal.showValidationMessage('Preencha todos os campos!');
                    return { r, a, e };
                }
            });

            if (formValues) {
                Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
                try {
                    await updateDoc(doc(db, "agendamentos", id), { 
                        disponivel: false, 
                        pai: `${formValues.r} (Aluno: ${formValues.a})` 
                    });

                    // Envio do E-mail via Google Script
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        mode: "no-cors",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            nomeResponsavel: formValues.r,
                            nomeAluno: formValues.a,
                            turma: turma,
                            emailProfessor: EMAILS_PROFESSORES[turma] || EMAILS_PROFESSORES["PADRAO"],
                            emailResponsavel: formValues.e,
                            data: dataBr,
                            horario: hora
                        })
                    });

                    Swal.fire('Sucesso!', 'Agendamento confirmado. Um e-mail foi enviado.', 'success');
                    selecionarTurma();
                } catch(e) {
                    Swal.fire('Erro', 'Falha ao salvar agendamento.', 'error');
                }
            }
        };

        window.gerarAutomatico = async () => {
            const t = document.getElementById('gen-turma').value;
            const d = document.getElementById('gen-data').value;
            const inicio = document.getElementById('gen-inicio').value;
            const fim = document.getElementById('gen-fim').value;
            if (!t || !d) return Swal.fire('Erro', 'Preencha Turma e Data!', 'error');

            const batch = writeBatch(db);
            let atual = new Date(`2000-01-01T${inicio}`);
            let limite = new Date(`2000-01-01T${fim}`);

            while (atual < limite) {
                const h = atual.toTimeString().substring(0, 5);
                const ref = doc(collection(db, "agendamentos"));
                batch.set(ref, {
                    turma: t, data: d, horario: h, disponivel: true, pai: "",
                    timestamp: new Date(`${d}T${h}`).getTime()
                });
                atual.setMinutes(atual.getMinutes() + 20);
            }
            await batch.commit();
            Swal.fire('Pronto!', 'Horários gerados.', 'success');
        };

        function renderAdminTable() {
            const tbody = document.getElementById('tabela-admin');
            tbody.innerHTML = todosDados.map(item => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-bold text-brandAzul">${item.turma}</td>
                    <td class="p-4"><b>${item.data.split('-').reverse().join('/')}</b> às ${item.horario}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 ${item.disponivel ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded-md text-[10px] font-bold uppercase">
                            ${item.disponivel ? 'Livre' : 'Agendado'}
                        </span>
                    </td>
                    <td class="p-4 text-xs">${item.pai || '—'}</td>
                    <td class="p-4 text-center">
                        <button onclick="deletar('${item.id}')" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        window.deletar = async (id) => {
            if (confirm('Excluir este horário?')) await deleteDoc(doc(db, "agendamentos", id));
        };

        window.limparTudo = async () => {
            const { value: confirmacao } = await Swal.fire({
                title: 'Atenção!', text: "Digite 'DELETAR' para apagar tudo.",
                input: 'text', showCancelButton: true
            });
            if (confirmacao === 'DELETAR') {
                const snapshot = await getDocs(collection(db, "agendamentos"));
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
                Swal.fire('Limpo!', 'Todos os horários foram excluídos.', 'success');
            }
        };

        window.imprimirRelatorio = () => {
            const filtro = document.getElementById('select-impressao').value;
            const area = document.getElementById('area-impressao');
            const dados = filtro ? todosDados.filter(i => i.turma === filtro) : todosDados;
            
            let html = `<div style="padding: 20px; font-family: sans-serif;">
                <h1 style="text-align: center; color: #003366;">Lista de Agendamentos - ${filtro || 'Todas as Turmas'}</h1>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead><tr style="border-bottom: 2px solid #000;">
                        <th style="text-align: left; padding: 10px;">Turma</th>
                        <th style="text-align: left; padding: 10px;">Data</th>
                        <th style="text-align: left; padding: 10px;">Hora</th>
                        <th style="text-align: left; padding: 10px;">Responsável / Aluno</th>
                    </tr></thead><tbody>`;
            
            dados.filter(i => !i.disponivel).forEach(item => {
                html += `<tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 10px;">${item.turma}</td>
                    <td style="padding: 10px;">${item.data.split('-').reverse().join('/')}</td>
                    <td style="padding: 10px;">${item.horario}</td>
                    <td style="padding: 10px;">${item.pai}</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            area.innerHTML = html;
            window.print();
        };

        function gerarQRCode() {
            const url = window.location.href.split('?')[0];
            const divQR = document.getElementById("qrcode");
            divQR.innerHTML = "";
            new QRCode(divQR, { text: url, width: 80, height: 80 });
        }

        window.copiarLink = () => {
            navigator.clipboard.writeText(window.location.href.split('?')[0]);
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Link copiado!', showConfirmButton: false, timer: 1500 });
        };

        window.compartilharZap = () => {
            const url = window.location.href.split('?')[0];
            const texto = `Olá! Segue o link para o agendamento da reunião escolar: ${url}`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`, '_blank');
        };
    </script>
</body>
</html>
